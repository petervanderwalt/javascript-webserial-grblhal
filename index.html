<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSerial CNC Control</title>

    <!-- Fonts: Nunito & Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">

    <!-- Icons & Xterm -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
          theme: {
              extend: {
                  colors: {
                      primary: {
                          DEFAULT: '#FFD949',
                          dark: '#D7B232',
                          light: '#FFF2AE'
                      }, // Solar Yellow
                      secondary: {
                          DEFAULT: '#6A6B6A',
                          dark: '#383838',
                          light: '#D9D9D8'
                      }, // Techno Graphite
                      grey: {
                          dark: '#2F373C',
                          DEFAULT: '#909090',
                          light: '#E2E8F0',
                          bg: '#F8F9FA'
                      },
                      surface: '#FFFFFF',
                      // CNC Standard Axis Colors
                      axis: {
                          x: '#EF4444', // Red
                          y: '#22C55E', // Green
                          z: '#3B82F6', // Blue
                          a: '#F59E0B'  // Orange
                      }
                  },
                  fontFamily: {
                      heading: ['Nunito', 'sans-serif'],
                      body: ['Roboto', 'sans-serif'],
                      mono: ['JetBrains Mono', 'monospace']
                  },
                  boxShadow: {
                      'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                      'card': '0 2px 4px rgba(0,0,0,0.05)'
                  }
              }
          }
      }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            /* Layout */
            .app-container { @apply flex h-screen w-screen overflow-hidden bg-grey-bg text-grey-dark font-body; }
            .sidebar { @apply w-[420px] flex-shrink-0 bg-white border-r border-grey-light flex flex-col z-30 shadow-soft; }

            /* Buttons */
            .btn { @apply px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed; }
            .btn-primary { @apply bg-primary text-black hover:bg-primary-dark shadow-sm; }
            .btn-secondary { @apply bg-white border-2 border-grey-light text-grey-dark hover:border-secondary hover:text-secondary; }
            .btn-danger { @apply bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white; }
            .btn-ghost { @apply text-grey hover:text-primary hover:bg-grey-bg rounded p-1; }
            .btn-icon { @apply p-2 rounded-md hover:bg-grey-bg transition-colors; }

            /* Overrides Button */
            .btn-ovr { @apply h-7 w-full bg-grey-light/50 hover:bg-secondary hover:text-white rounded text-[10px] font-bold text-grey-dark transition-colors border border-grey-light; }

            /* Inputs */
            .input-field { @apply w-full rounded-md border-2 border-grey-light bg-grey-bg px-3 py-2 text-sm font-bold text-grey-dark focus:border-secondary focus:bg-white outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed; }

            /* New DRO Cards (Compacted) */
            .dro-panel { @apply bg-grey-bg rounded-xl p-2 shadow-inner mb-2 border border-grey-light; }

            /* The Axis Card Container */
            .dro-card { @apply flex items-stretch bg-white rounded-md shadow-sm border border-grey-light mb-1 overflow-hidden transition-colors h-8; }

            /* The Axis Letter Box */
            .dro-label-box { @apply w-8 flex items-center justify-center font-heading font-black text-lg text-black; }

            /* The Number Area */
            .dro-readout { @apply flex-1 flex items-baseline justify-between gap-4 px-3 py-1 bg-white overflow-hidden; }

            /* Work Position (Big) - Right Aligned, takes remaining space */
            .dro-val-lg { @apply font-mono text-[24px] font-black tracking-tight text-grey-dark leading-none text-right flex-1 tabular-nums mb-0; }

            /* Machine Position (Small) - Fixed Width & Right Aligned */
            .dro-val-sm { @apply font-mono text-[16px] font-bold text-grey/80 tracking-wider leading-none text-right w-28 flex-shrink-0 tabular-nums; }

            /* The Zero Button inside the card */
            .dro-zero-btn { @apply w-10 border-l border-grey-light bg-grey-bg/30 hover:bg-primary hover:text-black hover:border-primary text-[9px] font-bold text-grey uppercase transition-colors flex items-center justify-center; }

            /* Sub-Controls (G28/G30) */
            .dro-sub-btn { @apply flex-1 bg-white border border-grey-light hover:border-secondary rounded text-[10px] font-bold text-grey-dark py-1 shadow-sm transition-all active:scale-95 flex items-center justify-center gap-1; }

            /* Jog Styles */
            .jog-wrapper { @apply flex gap-3 justify-center; }
            .jog-pad { @apply grid grid-cols-3 gap-1.5; }
            .jog-btn { @apply w-12 h-12 bg-white border-2 border-grey-light rounded-xl text-xl text-grey-dark hover:border-primary hover:text-primary hover:bg-primary-light active:bg-primary active:text-black transition-all shadow-sm flex items-center justify-center; }
            .jog-extra-col { @apply flex flex-col gap-1.5; }
            .jog-btn-extra { @apply w-12 h-[42px] bg-white border-2 border-grey-light rounded-xl text-sm font-bold text-grey-dark hover:border-secondary hover:text-secondary hover:bg-secondary-light active:bg-secondary active:text-white transition-all shadow-sm flex items-center justify-center; }

            /* Console */
            .console-wrapper { @apply flex-1 bg-white rounded-lg overflow-hidden p-2 shadow-inner border border-grey-light relative; }

            /* Tabs */
            .tab-nav { @apply flex bg-white border-b border-grey-light px-6 gap-2 pt-2; }
            .tab-btn { @apply py-3 px-4 text-sm font-bold text-grey transition-all flex items-center hover:text-white; }
            .tab-btn.active { @apply bg-grey-bg text-secondary-dark; }

            /* Viewer Overlay */
            .viewer-controls { @apply absolute top-4 right-4 flex flex-col gap-2 z-20; }
            .overlay-btn { @apply bg-white/90 backdrop-blur shadow-md px-3 py-2 rounded-lg text-xs font-bold text-grey-dark hover:text-primary hover:bg-white transition-all flex items-center gap-2; }
        }

        .xterm-viewport { overflow-y: auto !important; }
    </style>


    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }
    </script>
</head>
<body>

    <div class="app-container">

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Header -->
            <div class="h-11 flex items-center px-4 bg-secondary-dark text-white justify-between shadow-md z-20">
                <div class="flex items-center gap-3">
                    <a href="#"><img src="logo.png" alt="CNC Control" class="h-10"></a>
                    <!-- Connection Status Pill -->
                    <div class="flex items-center bg-black/20 px-2.5 py-0.5 rounded-full border border-white/10 text-[9px] font-bold uppercase tracking-wider">
                        <div id="connection-dot" class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                        <span id="connection-text">Offline</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <!-- Reset Button -->
                    <button id="btn-reset" class="btn h-8 text-xs shadow-none border border-white/10 opacity-50 pointer-events-none transition-opacity" onclick="sendRealtime('\x18')" title="Soft Reset"><i class="bi bi-exclamation-octagon-fill"></i> Reset</button>
                    <!-- Connect Button -->
                    <button id="btn-connect" class="btn btn-primary h-8 text-xs shadow-none border border-white/10">Connect</button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-2 flex flex-col gap-1">

                <!-- Machine Controls Wrapper (Disabled when offline) -->
                <div id="machine-controls" class="flex flex-col gap-1 opacity-50 pointer-events-none transition-opacity duration-200">

                    <!-- DRO (New Card Design - Side by Side) -->
                    <div class="dro-panel">

                        <!-- Header: WCS & Units -->
                        <div class="flex justify-between items-center mb-1.5 px-1">

                          <!-- Units Toggle -->
                          <label class="inline-flex items-center cursor-pointer bg-white border border-grey-light rounded px-2 py-0.5 shadow-sm gap-2">
                              <span class="text-[10px] font-black text-grey uppercase" id="unitLabel">MM</span>
                              <input type="checkbox" id="unitToggle" class="sr-only peer" checked onchange="window.dro.toggleUnits()">
                              <div class="relative w-6 h-3 bg-grey-light rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:border-grey-light after:border after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-secondary"></div>
                          </label>

                             <!-- WCS Select -->
                             <div class="flex items-center gap-2 bg-white border border-grey-light rounded px-2 py-0.5 shadow-sm">
                                <span class="text-[10px] font-black text-grey uppercase">WCS</span>
                                <select class="text-[11px] font-bold text-secondary-dark bg-transparent outline-none cursor-pointer py-0.5" onchange="window.dro.setWCS(this.value)">
                                    <option value="G54" selected>G54</option>
                                    <option value="G55">G55</option>
                                    <option value="G56">G56</option>
                                    <option value="G57">G57</option>
                                    <option value="G58">G58</option>
                                    <option value="G59">G59</option>
                                </select>
                            </div>


                        </div>

                        <!-- X Axis -->
                        <div class="dro-card border-l-4 border-l-axis-x">
                            <div class="dro-label-box">X</div>
                            <div class="dro-readout">
                                <span id="dro-x-m" class="dro-val-sm">0.000</span>
                                <span id="dro-x" class="dro-val-lg">0.000</span>
                            </div>
                            <button class="dro-zero-btn" onclick="window.dro.setZero('X')">Zero</button>
                        </div>

                        <!-- Y Axis -->
                        <div class="dro-card border-l-4 border-l-axis-y">
                            <div class="dro-label-box">Y</div>
                            <div class="dro-readout">
                                <span id="dro-y-m" class="dro-val-sm">0.000</span>
                                <span id="dro-y" class="dro-val-lg">0.000</span>
                            </div>
                            <button class="dro-zero-btn" onclick="window.dro.setZero('Y')">Zero</button>
                        </div>

                        <!-- Z Axis -->
                        <div class="dro-card border-l-4 border-l-axis-z">
                            <div class="dro-label-box">Z</div>
                            <div class="dro-readout">
                                <span id="dro-z-m" class="dro-val-sm">0.000</span>
                                <span id="dro-z" class="dro-val-lg">0.000</span>
                            </div>
                            <button class="dro-zero-btn" onclick="window.dro.setZero('Z')">Zero</button>
                        </div>

                        <!-- A Axis (Hidden by default) -->
                        <div class="dro-row hidden dro-card border-l-4 border-l-axis-a">
                            <div class="dro-label-box">A</div>
                            <div class="dro-readout">
                                <span id="dro-a-m" class="dro-val-sm">0.000</span>
                                <span id="dro-a" class="dro-val-lg">0.000</span>
                            </div>
                            <button class="dro-zero-btn" onclick="window.dro.setZero('A')">Zero</button>
                        </div>

                        <!-- Predefined Positions Grid -->
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <!-- G28 -->
                            <div class="flex gap-1 bg-white p-1 rounded border border-grey-light">
                                <span class="text-[9px] font-black text-grey w-6 flex items-center justify-center">G28</span>
                                <button class="dro-sub-btn" onclick="window.dro.goToPredefined(28)" title="Go To"><i class="bi bi-play-fill"></i> Go</button>
                                <button class="dro-sub-btn" onclick="window.dro.setPredefined(28)" title="Set Here"><i class="bi bi-crosshair"></i> Set</button>
                            </div>
                            <!-- G30 -->
                             <div class="flex gap-1 bg-white p-1 rounded border border-grey-light">
                                <span class="text-[9px] font-black text-grey w-6 flex items-center justify-center">G30</span>
                                <button class="dro-sub-btn" onclick="window.dro.goToPredefined(30)" title="Go To"><i class="bi bi-play-fill"></i> Go</button>
                                <button class="dro-sub-btn" onclick="window.dro.setPredefined(30)" title="Set Here"><i class="bi bi-crosshair"></i> Set</button>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="grid grid-cols-3 gap-2 mt-2 pt-2 border-t border-grey-light/50">
                             <div class="col-span-1 flex items-center">
                                 <span id="machine-state" class="machine-status-pill w-full text-center">Unknown</span>
                             </div>
                             <div class="col-span-2 flex gap-1">
                                <button class="dro-sub-btn !bg-primary !text-black !border-primary hover:!bg-primary-dark" onclick="window.dro.home()">
                                    <i class="bi bi-house-door-fill"></i> HOME
                                </button>
                                <button class="dro-sub-btn" onclick="window.dro.setZero('XYZ')">SET ZERO ALL</button>
                                <button class="dro-sub-btn" onclick="window.dro.goXY0()">SET XY 0</button>
                             </div>
                        </div>
                    </div>

                    <!-- Overrides (Compact) -->
                    <div class="bg-white p-2 rounded-xl border border-grey-light shadow-card">
                        <!-- Header -->

                        <div class="flex flex-col gap-1.5">

                            <!-- Row 1: Feed & Spindle Side-by-Side -->
                            <div class="grid grid-cols-2 gap-2">
                                <!-- Feed -->
                                <div class="flex flex-col gap-0.5">
                                    <div class="flex justify-between text-[9px] font-bold text-grey-dark px-0.5">
                                        <span><i class="bi bi-speedometer2"></i> Feed</span>
                                    </div>
                                    <div class="flex gap-0.5">
                                        <button class="btn-ovr h-6 flex-1 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 border-red-100" onclick="sendRealtime('\x92')" title="-10%">-10</button>
                                        <button class="btn-ovr h-6 flex-1 !bg-white !text-black border-grey-light" onclick="sendRealtime('\x90')" title="Reset 100%">100</button>
                                        <button class="btn-ovr h-6 flex-1 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 border-green-100" onclick="sendRealtime('\x91')" title="+10%">+10</button>
                                    </div>
                                </div>

                                <!-- Spindle -->
                                <div class="flex flex-col gap-0.5">
                                    <div class="flex justify-between text-[9px] font-bold text-grey-dark px-0.5">
                                        <span><i class="bi bi-fan"></i> Spindle</span>
                                    </div>
                                    <div class="flex gap-0.5">
                                        <button class="btn-ovr h-6 flex-1 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 border-red-100" onclick="sendRealtime('\x9B')" title="-10%">-10</button>
                                        <button class="btn-ovr h-6 flex-1 !bg-white !text-black border-grey-light" onclick="sendRealtime('\x99')" title="Reset 100%">100</button>
                                        <button class="btn-ovr h-6 flex-1 bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700 border-green-100" onclick="sendRealtime('\x9A')" title="+10%">+10</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Rapids (Full Width) -->
                            <div class="flex items-center gap-1 bg-grey-bg/50 p-1 rounded border border-grey-light/50">
                                <span class="text-[9px] font-bold text-grey-dark w-12 shrink-0"><i class="bi bi-lightning-charge-fill text-primary"></i> Rapid</span>
                                <div class="flex gap-1 flex-1">
                                    <button class="btn-ovr h-5 flex-1" onclick="sendRealtime('\x97')">25%</button>
                                    <button class="btn-ovr h-5 flex-1" onclick="sendRealtime('\x96')">50%</button>
                                    <button class="btn-ovr h-5 flex-1 !bg-white !text-black" onclick="sendRealtime('\x95')">100%</button>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Jog Controls (Compact) -->
                    <div class="bg-white p-3 rounded-xl border border-grey-light shadow-card">

                        <div class="jog-wrapper">
                            <!-- XY Pad -->
                            <div class="jog-pad">
                                <button class="jog-btn rounded-tl-xl" data-jog="X-Y+"><i class="bi bi-arrow-up-left"></i></button>
                                <button class="jog-btn" data-jog="Y+"><i class="bi bi-caret-up-fill text-2xl"></i></button>
                                <button class="jog-btn rounded-tr-xl" data-jog="X+Y+"><i class="bi bi-arrow-up-right"></i></button>

                                <button class="jog-btn" data-jog="X-"><i class="bi bi-caret-left-fill text-2xl"></i></button>
                                <div class="w-12 h-12 flex items-center justify-center">
                                    <i class="bi bi-dpad-fill text-2xl text-grey-light"></i>
                                </div>
                                <button class="jog-btn" data-jog="X+"><i class="bi bi-caret-right-fill text-2xl"></i></button>

                                <button class="jog-btn rounded-bl-xl" data-jog="X-Y-"><i class="bi bi-arrow-down-left"></i></button>
                                <button class="jog-btn" data-jog="Y-"><i class="bi bi-caret-down-fill text-2xl"></i></button>
                                <button class="jog-btn rounded-br-xl" data-jog="X+Y-"><i class="bi bi-arrow-down-right"></i></button>
                            </div>

                            <!-- Right Column: Unlock + Z & A, CONTINUOUS -->
                            <div class="flex flex-col gap-2 w-28">
                                <!-- Unlock Button -->
                                <button class="btn btn-secondary w-full h-8 text-xs justify-center shadow-none" onclick="sendCmd('$X')" title="Unlock ($X)"><i class="bi bi-unlock-fill"></i> Unlock</button>

                                <!-- Z & A Buttons -->
                                <div class="flex gap-1.5 justify-center">
                                     <!-- Z Pad -->
                                    <div class="jog-extra-col">
                                        <button class="jog-btn-extra rounded-t-xl" data-jog="Z+">Z+</button>
                                        <button class="jog-btn-extra rounded-b-xl" data-jog="Z-">Z-</button>
                                    </div>
                                     <!-- A Pad -->
                                    <div class="jog-extra-col">
                                        <button class="jog-btn-extra rounded-t-xl" data-jog="A+">A+</button>
                                        <button class="jog-btn-extra rounded-b-xl" data-jog="A-">A-</button>
                                    </div>
                                </div>

                                <!-- Continuous Toggle -->
                                <label class="inline-flex justify-center cursor-pointer gap-2 mt-1">
                                    <span class="text-[12px] font-bold text-grey uppercase">Incr</span>
                                    <input type="checkbox" id="jogContinuous" class="sr-only peer">
                                    <div class="relative w-6 h-4 bg-grey-light/50 border border-grey-light peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-secondary"></div>
                                    <span class="text-[12px] font-bold text-grey uppercase">Cont</span>
                                </label>
                            </div>
                        </div>

                        <!-- Step/Feed -->
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div class="relative">
                                <span class="absolute left-2 top-2 text-[9px] font-bold text-grey uppercase">Dist</span>
                                <select id="stepSize" class="input-field pl-8 text-right h-8 py-0">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="relative">
                                <span class="absolute left-2 top-2 text-[9px] font-bold text-grey uppercase">Feed</span>
                                <input type="number" id="feedRate" class="input-field pl-8 text-right h-8 py-0">
                            </div>
                        </div>
                    </div>
                </div> <!-- End Machine Controls -->

                <!-- Console (Light Mode) -->
                <div class="flex-1 flex flex-col min-h-[150px]">
                    <div class="console-wrapper">
                        <div id="terminal-container" class="w-full h-full"></div>
                    </div>
                    <!-- Console Input (Disabled when offline) -->
                    <div id="console-input-area" class="flex gap-2 mt-2 opacity-50 pointer-events-none transition-opacity duration-200">
                        <input type="text" id="cmdInput" class="input-field font-mono h-8" placeholder="G-Code...">
                        <button id="btnSend" class="btn btn-secondary px-3 h-8"><i class="bi bi-send-fill text-xs"></i></button>
                        <button class="btn-ghost text-xs" onclick="clearTerminal()"><i class="bi bi-trash"></i></button>
                    </div>
                </div>

            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-grey-bg relative overflow-hidden">

            <!-- Navigation -->
            <div class="tab-nav p-0 m-0 bg-secondary-dark">
                <button class="tab-btn active" onclick="switchTab('viewer-view', this)">3D Preview</button>
                <button class="tab-btn" onclick="switchTab('probe-view', this)">Probe</button>
                <button class="tab-btn" onclick="switchTab('surfacing-view', this)">Surfacing</button>
                <button class="tab-btn" onclick="switchTab('sd-view', this)">
                    SD Card
                    <span id="sd-badge" class="hidden ml-2 bg-primary text-black text-[10px] font-bold px-1.5 py-0 rounded-full">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('settings-view', this)">Settings</button>
            </div>

            <!-- Content -->
            <div class="flex-1 relative overflow-hidden"> <!-- Added overflow-hidden here for strict constraint -->

                <!-- 3D Viewer (Default) -->
                <div id="viewer-view" class="tab-pane w-full h-full relative bg-grey-light/30">
                    <div id="viewer-container" class="absolute inset-0"></div>

                    <!-- Loading Overlay -->
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                        <div class="bg-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                            <div class="w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                            <span class="font-bold text-grey-dark">Parsing G-Code...</span>
                        </div>
                    </div>

                    <!-- Viewer Controls -->
                    <div class="viewer-controls">
                        <!-- Run Job (Disabled when offline) -->
                        <button id="run-job-btn" class="overlay-btn !bg-primary !text-secondary-dark hover:!bg-primary-dark shadow-lg opacity-50 pointer-events-none transition-opacity duration-200" onclick="runCurrentJob()">
                            <i class="bi bi-play-fill text-lg"></i> Run Job
                        </button>

                        <!-- Job Running Controls (Pause/Stop) -->
                        <div id="job-active-controls" class="hidden flex-col gap-2">
                             <button id="pause-job-btn" class="overlay-btn !bg-yellow-100 !text-yellow-800 border-yellow-300 shadow-lg" onclick="pauseJob()">
                                <i class="bi bi-pause-fill text-lg"></i> Pause
                            </button>
                            <button id="stop-job-btn" class="overlay-btn !bg-red-100 !text-red-800 border-red-300 shadow-lg" onclick="stopJob()">
                                <i class="bi bi-stop-fill text-lg"></i> Stop
                            </button>
                        </div>

                        <!-- Camera View Shortcuts -->
                        <div class="flex gap-1 bg-white/90 p-1 rounded-lg shadow-md mt-4 backdrop-blur">
                            <button class="btn-ghost text-[10px] font-bold uppercase w-8" onclick="window.viewer.setCameraView('Top')">Top</button>
                            <button class="btn-ghost text-[10px] font-bold uppercase w-8" onclick="window.viewer.setCameraView('Front')">Frt</button>
                            <button class="btn-ghost text-[10px] font-bold uppercase w-8" onclick="window.viewer.setCameraView('Left')">Lft</button>
                            <button class="btn-ghost text-[10px] font-bold uppercase w-8" onclick="window.viewer.setCameraView('Iso')">Iso</button>
                        </div>

                        <button class="overlay-btn" onclick="resetCamera()">
                            <i class="bi bi-camera-video-fill text-secondary"></i> Reset
                        </button>
                        <button class="overlay-btn" onclick="toggleCamera()" id="cam-toggle-btn">
                            <i class="bi bi-box-fill text-secondary"></i> Ortho
                        </button>
                        <label class="overlay-btn cursor-pointer">
                            <i class="bi bi-folder2-open text-secondary"></i> Open File
                            <input type="file" id="gcode-file-input" hidden accept=".gcode,.nc,.gc,.ngc">
                        </label>
                    </div>
                </div>

                <!-- Surfacing Wizard -->
                <div id="surfacing-view" class="tab-pane hidden w-full h-full p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2"><i class="bi bi-layers-fill"></i> Surfacing Wizard</h2>
                                <p class="text-sm text-grey">Generate G-code to flatten stock or spoilboards.</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary shadow-soft" onclick="window.surfacing.loadToViewer()"><i class="bi bi-check-lg"></i> Generate G-Code</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Column 1: Specs -->
                            <div class="space-y-6">
                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3 class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">Tool & Speeds</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Tool Diameter (mm)</label><input type="number" id="surf-tool" class="input-field font-mono text-sm"></div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Stepover (%)</label><input type="number" id="surf-stepover" class="input-field font-mono text-sm"></div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Feed Rate (mm/min)</label><input type="number" id="surf-feed" class="input-field font-mono text-sm"></div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Spindle RPM</label><input type="number" id="surf-rpm" class="input-field font-mono text-sm"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3 class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">Dimensions</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Width (X)</label><input type="number" id="surf-x" class="input-field font-mono text-sm"></div>
                                            <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Height (Y)</label><input type="number" id="surf-y" class="input-field font-mono text-sm"></div>
                                        </div>
                                        <div>
                                            <label class="text-[11px] font-bold text-secondary-dark block mb-1">Cutting Direction</label>
                                            <select id="surf-dir" class="input-field text-sm">
                                                <option value="X">Along X-Axis</option>
                                                <option value="Y">Along Y-Axis</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2: Depth & Options -->
                            <div class="space-y-6">
                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3 class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">Depth Control</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Depth per Pass (mm)</label><input type="number" id="surf-z-step" class="input-field font-mono text-sm"></div>
                                            <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Final Depth (mm)</label><input type="number" id="surf-z-final" class="input-field font-mono text-sm"></div>
                                        </div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Safe Z Clearance (mm)</label><input type="number" id="surf-z-safe" class="input-field font-mono text-sm"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3 class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">Options</h3>

                                    <div class="flex items-center justify-between bg-grey-bg/50 p-3 rounded-lg border border-grey-light mb-2">
                                        <span class="text-xs font-bold text-secondary-dark">Use Coolant (M8)?</span>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="surf-coolant" class="sr-only peer">
                                            <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                                        </label>
                                    </div>

                                    <div class="flex items-center justify-between bg-grey-bg/50 p-3 rounded-lg border border-grey-light">
                                        <span class="text-xs font-bold text-secondary-dark">Add Framing Pass?</span>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="surf-framing" class="sr-only peer">
                                            <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                                        </label>
                                    </div>

                                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-[11px] text-yellow-800">
                                        <i class="bi bi-info-circle-fill mr-1"></i>
                                        Ensure your spindle is trammed perpendicular to the bed. Start Z-Zero at the highest point of your stock.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SD Card -->
                <div id="sd-view" class="tab-pane hidden w-full h-full p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sd-card-fill"></i> SD Card
                                </h2>
                                <p class="text-sm text-grey">Manage files stored on your controller.</p>
                            </div>
                            <!-- SD Actions (Disabled when offline) -->
                            <div id="sd-tools" class="flex gap-2 opacity-50 pointer-events-none transition-opacity duration-200">
                                <button class="btn btn-primary shadow-soft" onclick="document.getElementById('sd-upload-input').click()">
                                    <i class="bi bi-cloud-upload-fill"></i> Upload
                                </button>
                                <button class="btn btn-secondary shadow-soft" onclick="window.sdHandler.refresh()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <input type="file" id="sd-upload-input" hidden>
                        </div>

                        <!-- Breadcrumb (Disabled when offline) -->
                        <div id="sd-breadcrumb" class="bg-white border border-grey-light rounded-lg p-3 mb-4 flex items-center gap-3 shadow-card opacity-50 pointer-events-none transition-opacity duration-200">
                            <button class="btn-icon text-grey-dark" onclick="window.sdHandler.upLevel()">
                                <i class="bi bi-arrow-90deg-up"></i>
                            </button>
                            <span class="text-grey-light">|</span>
                            <span id="sd-current-path" class="font-mono font-bold text-grey-dark">/</span>
                        </div>

                        <!-- Upload Progress -->
                        <div id="upload-progress-container" class="hidden mb-6 bg-white p-4 rounded-lg border border-grey-light shadow-soft">
                            <div class="flex justify-between text-xs font-bold text-grey mb-2 uppercase">
                                <span>Transferring...</span>
                                <span id="upload-pct">0%</span>
                            </div>
                            <div class="h-2 w-full bg-grey-bg rounded-full overflow-hidden">
                                <div id="upload-progress-bar" class="h-full bg-primary transition-all duration-300 w-0"></div>
                            </div>
                        </div>

                        <!-- File Table (Restored White) -->
                        <div class="bg-white border border-grey-light rounded-xl shadow-soft overflow-hidden">
                            <table class="w-full text-left text-sm" id="sd-table">
                                <thead class="bg-grey-bg border-b border-grey-light text-grey uppercase text-[10px] tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 font-bold">Filename</th>
                                        <th class="px-6 py-4 font-bold">Size</th>
                                        <th class="px-6 py-4 font-bold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-grey-light">
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center text-grey italic">
                                            Click Refresh to load files...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Grbl Settings -->
                <div id="settings-view" class="tab-pane hidden w-full h-full p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sliders"></i> Machine Settings
                                </h2>
                                <p class="text-sm text-grey">Configure GrblHAL firmware parameters.</p>
                            </div>
                            <div class="flex gap-2" id="settings-toolbar">
                                <button class="btn btn-secondary" onclick="window.grblSettings.fetchSettings()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-secondary" onclick="window.grblSettings.backup()">
                                    <i class="bi bi-download"></i> Backup
                                </button>
                                <button class="btn btn-secondary" onclick="document.getElementById('settings-restore-input').click()">
                                    <i class="bi bi-upload"></i> Restore
                                </button>
                                <input type="file" id="settings-restore-input" hidden onchange="window.grblSettings.restore(this.files[0])">

                                <button class="btn btn-primary" onclick="window.grblSettings.saveChanges()">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                            </div>
                        </div>

                        <!-- Settings Table Container (Removed clipping/styling to fix scroll) -->
                        <div id="grbl-settings-container">
                            <!-- populated by js -->
                        </div>
                    </div>
                </div>

                <!-- Probing Tab -->
                <div id="probe-view" class="tab-pane hidden w-full h-full bg-grey-bg overflow-y-auto">
                    <!-- Added ID for enabling/disabling content -->
                    <div id="probe-panel-content" class="max-w-6xl mx-auto p-6 opacity-50 pointer-events-none transition-opacity duration-200">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-bullseye"></i> Probe Operations
                                </h2>
                                <p class="text-sm text-grey">Configure geometry and execute probing cycles.</p>
                            </div>
                            <button class="btn btn-primary shadow-soft" onclick="window.probeHandler.saveSettings()">
                                <i class="bi bi-save"></i> Save Settings
                            </button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <!-- Left: Config -->
                            <div class="lg:col-span-4 xl:col-span-3">
                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft sticky top-4">
                                    <h3 class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        <i class="bi bi-sliders"></i> Configuration
                                    </h3>
                                    <div class="space-y-4">

                                        <!-- GLOBAL TOGGLE -->
                                        <div class="bg-grey-bg/50 p-3 rounded-lg border border-grey-light flex justify-between items-center">
                                            <span class="text-xs font-bold text-secondary-dark">Use Probe Plate?</span>
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="prb-use-plate-main" class="sr-only peer" onchange="window.probeHandler.saveSettings()">
                                                <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                                            </label>
                                        </div>

                                        <div class="space-y-2">
                                            <label class="text-[11px] font-bold text-secondary-dark block">Probe Diameter (mm)</label>
                                            <div class="relative">
                                                <input type="number" id="prb-tool" class="input-field pl-8 font-mono text-sm" step="0.01">
                                                <i class="bi bi-vinyl absolute left-2.5 top-2 text-grey"></i>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="text-[11px] font-bold text-secondary-dark block">Z Plate Thickness (mm)</label>
                                            <div class="relative">
                                                <input type="number" id="prb-z-thick" class="input-field pl-8 font-mono text-sm" step="0.01">
                                                <i class="bi bi-arrow-bar-down absolute left-2.5 top-2 text-grey"></i>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="text-[11px] font-bold text-secondary-dark block">XY Plate Offset (mm)</label>
                                            <div class="relative">
                                                <input type="number" id="prb-xy-offset" class="input-field pl-8 font-mono text-sm" step="0.01" title="Width of the probe block shoulder">
                                                <i class="bi bi-arrow-bar-right absolute left-2.5 top-2 text-grey"></i>
                                            </div>
                                        </div>
                                        <hr class="border-grey-light/50">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Feedrate</label><input type="number" id="prb-feed" class="input-field font-mono text-xs h-8"></div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Latch Feed</label><input type="number" id="prb-feed-latch" class="input-field font-mono text-xs h-8"></div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Max Travel</label><input type="number" id="prb-dist" class="input-field font-mono text-xs h-8"></div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Retract</label><input type="number" id="prb-retract" class="input-field font-mono text-xs h-8"></div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">XY Clearance</label><input type="number" id="prb-edge-dist" class="input-field font-mono text-xs h-8"></div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Z Depth</label><input type="number" id="prb-z-depth" class="input-field font-mono text-xs h-8"></div>
                                        </div>
                                        <hr class="border-grey-light/50">
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <label class="text-[11px] font-bold text-secondary-dark">Boss / Stock Size</label>
                                                <i class="bi bi-info-circle text-[10px] text-grey" title="Required for Outside Boss probing."></i>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label class="text-[9px] font-bold text-grey block mb-1">Width (X)</label><input type="number" id="prb-boss-x" class="input-field font-mono text-xs h-8" placeholder="0.00"></div>
                                                <div><label class="text-[9px] font-bold text-grey block mb-1">Height (Y)</label><input type="number" id="prb-boss-y" class="input-field font-mono text-xs h-8" placeholder="0.00"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Right: Operations -->
                            <div class="lg:col-span-8 xl:col-span-9 space-y-5">

                                <!-- Corners -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div class="bg-white p-5 rounded-xl shadow-soft border border-grey-light flex flex-col">
                                        <div class="flex justify-between items-start mb-4">
                                            <div><h3 class="font-bold text-secondary-dark text-sm flex items-center gap-2"><i class="bi bi-box"></i> Outside Corner</h3><p class="text-[10px] text-grey mt-0.5">Probe corner (Stock).</p></div>
                                            <span class="text-[9px] text-grey font-bold plate-status-text mt-1">Mode: Plate</span>
                                        </div>
                                        <div class="flex gap-5 flex-1">
                                            <div class="w-28 h-28 grid grid-cols-2 gap-1 flex-shrink-0 self-center">
                                                <button class="corner-sel-btn rounded-tl-lg bg-grey-bg border border-grey-light hover:bg-primary hover:border-primary transition-colors h-full" data-corner="RL" onclick="window.probeHandler.selectCorner(this, 'Outside', 'RL')"></button>
                                                <button class="corner-sel-btn rounded-tr-lg bg-grey-bg border border-grey-light hover:bg-primary hover:border-primary transition-colors h-full" data-corner="RR" onclick="window.probeHandler.selectCorner(this, 'Outside', 'RR')"></button>
                                                <button class="corner-sel-btn rounded-bl-lg bg-primary border-2 border-black/20 ring-2 ring-primary/30 h-full" data-corner="FL" onclick="window.probeHandler.selectCorner(this, 'Outside', 'FL')"></button>
                                                <button class="corner-sel-btn rounded-br-lg bg-grey-bg border border-grey-light hover:bg-primary hover:border-primary transition-colors h-full" data-corner="FR" onclick="window.probeHandler.selectCorner(this, 'Outside', 'FR')"></button>
                                            </div>
                                            <div class="flex-1 flex flex-col justify-center gap-3">
                                                <div class="text-[11px] text-grey leading-tight space-y-1"><p>1. Position probe above corner.</p><p>2. Ensure Z path is clear.</p></div>
                                                <button class="btn btn-primary w-full justify-center mt-auto" onclick="window.probeHandler.runCornerProbe('Outside')">Probe Corner</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-soft border border-grey-light flex flex-col">
                                        <div class="flex justify-between items-start mb-4">
                                            <div><h3 class="font-bold text-secondary-dark text-sm flex items-center gap-2"><i class="bi bi-bounding-box"></i> Inside Corner</h3><p class="text-[10px] text-grey mt-0.5">Probe corner (Hole/Pocket).</p></div>
                                            <span class="text-[9px] text-grey font-bold plate-status-text mt-1">Mode: Plate</span>
                                        </div>
                                        <div class="flex gap-5 flex-1">
                                            <div class="w-28 h-28 grid grid-cols-2 gap-1 flex-shrink-0 p-1.5 bg-grey-light rounded-xl self-center">
                                                <button class="corner-sel-btn rounded-tl shadow-inner bg-white hover:bg-primary transition-colors h-full" onclick="window.probeHandler.selectCorner(this, 'Inside', 'RL')"></button>
                                                <button class="corner-sel-btn rounded-tr shadow-inner bg-white hover:bg-primary transition-colors h-full" onclick="window.probeHandler.selectCorner(this, 'Inside', 'RR')"></button>
                                                <button class="corner-sel-btn rounded-bl bg-primary border-2 border-black/20 ring-2 ring-primary/30 h-full" onclick="window.probeHandler.selectCorner(this, 'Inside', 'FL')"></button>
                                                <button class="corner-sel-btn rounded-br shadow-inner bg-white hover:bg-primary transition-colors h-full" onclick="window.probeHandler.selectCorner(this, 'Inside', 'FR')"></button>
                                            </div>
                                            <div class="flex-1 flex flex-col justify-center gap-3">
                                                <p class="text-[11px] text-grey leading-tight">Position probe roughly inside the corner of a pocket or hole.</p>
                                                <button class="btn btn-secondary w-full justify-center mt-auto" onclick="window.probeHandler.runCornerProbe('Inside')">Probe Inner</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Single Axis -->
                                <div class="bg-white p-4 rounded-xl shadow-soft border border-grey-light">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-bold text-secondary-dark text-xs uppercase tracking-wider">Single Surface</h3>
                                        <span class="text-[10px] text-grey font-bold plate-status-text">Mode: Plate</span>
                                    </div>
                                    <div class="flex gap-3 overflow-x-auto pb-1">
                                        <button class="btn btn-secondary flex-1 py-4 flex-col gap-2 h-auto min-w-[80px]" onclick="window.probeHandler.runSingleAxis('X', 1)"><i class="bi bi-arrow-bar-right text-2xl text-grey-dark"></i><span class="text-xs font-bold">Find X+</span></button>
                                        <button class="btn btn-secondary flex-1 py-4 flex-col gap-2 h-auto min-w-[80px]" onclick="window.probeHandler.runSingleAxis('X', -1)"><i class="bi bi-arrow-bar-left text-2xl text-grey-dark"></i><span class="text-xs font-bold">Find X-</span></button>
                                        <button class="btn btn-secondary flex-1 py-4 flex-col gap-2 h-auto min-w-[80px]" onclick="window.probeHandler.runSingleAxis('Y', 1)"><i class="bi bi-arrow-bar-up text-2xl text-grey-dark"></i><span class="text-xs font-bold">Find Y+</span></button>
                                        <button class="btn btn-secondary flex-1 py-4 flex-col gap-2 h-auto min-w-[80px]" onclick="window.probeHandler.runSingleAxis('Y', -1)"><i class="bi bi-arrow-bar-down text-2xl text-grey-dark"></i><span class="text-xs font-bold">Find Y-</span></button>
                                        <button class="btn btn-secondary flex-1 py-4 flex-col gap-2 h-auto min-w-[80px] !bg-primary/10 !border-primary/50 !text-secondary-dark hover:!bg-primary hover:!border-primary hover:!text-black" onclick="window.probeHandler.runZProbe()"><i class="bi bi-arrow-bar-down text-2xl"></i><span class="text-xs font-bold">Find Z-</span></button>
                                    </div>
                                </div>

                                <!-- Centers -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                                    <div class="bg-white p-5 rounded-xl shadow-soft border border-grey-light flex flex-col items-center text-center">
                                        <div class="w-12 h-12 bg-grey-bg rounded-full flex items-center justify-center mb-3 text-secondary"><i class="bi bi-circle-square text-2xl"></i></div>
                                        <h4 class="font-bold text-sm text-secondary-dark">Pocket Center</h4>
                                        <span class="text-[10px] text-grey uppercase mb-4">Inside Hole/Rect</span>
                                        <button class="btn btn-secondary w-full mt-auto" onclick="window.probeHandler.runPocketCenter()">Find Center</button>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-soft border border-grey-light flex flex-col items-center text-center">
                                        <div class="w-12 h-12 bg-grey-bg rounded-full flex items-center justify-center mb-3 text-secondary"><i class="bi bi-square-fill text-2xl"></i></div>
                                        <h4 class="font-bold text-sm text-secondary-dark">Rect Boss</h4>
                                        <span class="text-[10px] text-grey uppercase mb-4">Uses Stock Size</span>
                                        <button class="btn btn-secondary w-full mt-auto" onclick="window.probeHandler.runBossCenter('Rect')">Find Center</button>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-soft border border-grey-light flex flex-col items-center text-center">
                                        <div class="w-12 h-12 bg-grey-bg rounded-full flex items-center justify-center mb-3 text-secondary"><i class="bi bi-circle-fill text-2xl"></i></div>
                                        <h4 class="font-bold text-sm text-secondary-dark">Circular Boss</h4>
                                        <span class="text-[10px] text-grey uppercase mb-4">Uses Stock Dia</span>
                                        <button class="btn btn-secondary w-full mt-auto" onclick="window.probeHandler.runBossCenter('Circ')">Find Center</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        function switchTab(targetId, btn) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(targetId);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if(targetId === 'viewer-view') {
                window.dispatchEvent(new Event('resize'));
                window.dispatchEvent(new CustomEvent('tab-shown', { detail: { id: targetId } }));
            }
        }
    </script>

    <script type="module">
            import { WebSerial } from './webserial.js';
            import { GCodeViewer } from './3dview.js';
            import { ProbeHandler } from './probe.js';
            import { SDCardHandler } from './sdcard.js';
            import { AlarmsAndErrors } from './alarms_and_errors.js';
            import { DROHandler } from './DRO.js';
            import { GrblSettings } from './grbl_settings.js';
            import { AppStore } from './store.js';
            import { SurfacingHandler } from './surfacing.js';

            // Globals
            const ws = new WebSerial();
            const store = new AppStore();

            window.addEventListener('beforeunload', (e) => {
                if (ws && ws.isConnected) {
                    e.preventDefault();
                    e.returnValue = "Closing this tab will disconnect the CNC controller. Are you sure?";
                    return e.returnValue;
                }
            });

            const viewer = new GCodeViewer('viewer-container', 'loading-overlay');
            const reporter = new AlarmsAndErrors(ws);
            window.viewer = viewer;

            // --- ERROR HANDLING ---
            ws.on('error', (err) => {
                let msg = err.message;
                let code = "Connection";

                // Make common errors friendlier
                if(msg.includes("Failed to open serial port")) {
                    msg = "Unable to open serial port. It may be in use by another application or tab.";
                    code = "Port Busy";
                }

                reporter.showModal('ERROR', code, msg);
            });
            // -----------------------

            let term, fitAddon, statusInterval;

            let currentGCodeContent = null;
            let gcodeStreamer = { active: false, lines: [], index: 0, paused: false };
            let commandHistory = [];
            let historyIndex = -1;
            let sdHandler = null;
            let droHandler = null;
            let grblSettings = null;
            let probeHandler = null;
            let surfacingHandler = null;


            document.addEventListener('DOMContentLoaded', () => {
                initTerminal();

                // Initialize Helpers with Store
                droHandler = new DROHandler(ws, term, store);
                window.dro = droHandler;

                grblSettings = new GrblSettings(ws, term);
                grblSettings.init('grbl-settings-container');
                window.grblSettings = grblSettings;

                sdHandler = new SDCardHandler(ws, term, viewer, {
                    onDownloadComplete: (content) => {
                        currentGCodeContent = content;
                    },
                    switchToViewer: () => {
                        switchTab('viewer-view');
                    },
                    pausePolling: () => {
                        if (statusInterval) clearInterval(statusInterval);
                    },
                    resumePolling: () => {
                        statusInterval = setInterval(() => ws.sendRealtime('?'), 50);
                    }
                });
                window.sdHandler = sdHandler;

                // Initialize Probe Handler with Store
                probeHandler = new ProbeHandler(ws, term, store);
                window.probeHandler = probeHandler;

                // Initialize Surfacing Handler
                surfacingHandler = new SurfacingHandler(viewer, sdHandler, term, store);
                window.surfacing = surfacingHandler;

                // Listen for generated gcode from surfacing
                window.addEventListener('gcode-loaded', (e) => {
                    currentGCodeContent = e.detail;
                });

                ws.on('connect', () => updateUIConnected(true));
                ws.on('disconnect', () => updateUIConnected(false));
                ws.on('line', (line) => processLine(line));
                ws.on('sent', (line) => {
                    if (window.sdHandler?.isDownloading) return;
                    if (gcodeStreamer.active) return;
                    if (line === '?' || line === '$G') return;
                    term.writeln(`\x1b[2m> ${line}\x1b[0m`);
                });

                const connectBtn = document.getElementById('btn-connect');
                connectBtn.addEventListener('click', () => {
                    if(ws.isConnected) {
                        ws.disconnect();
                    } else {
                        // Connect, but catch errors to prevent console spam since we handle them in the 'error' event now
                        ws.connect(115200).catch(e => {
                            // Handled by ws.on('error') or ignored (if cancelled)
                        });
                    }
                });

                document.getElementById('btnSend').addEventListener('click', sendFromInput);

                document.getElementById('cmdInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        sendFromInput();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateHistory(-1);
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateHistory(1);
                    }
                });

                document.getElementById('gcode-file-input').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        currentGCodeContent = evt.target.result;
                        viewer.processGCodeString(currentGCodeContent);
                        // Reset input so same file can be selected again if needed
                        e.target.value = '';
                    };
                    reader.readAsText(file);
                });
                document.getElementById('sd-upload-input').addEventListener('change', (e) => sdHandler.startUpload(e.target.files[0]));

                window.addEventListener('resize', () => { fitAddon.fit(); viewer.resize(); });
                window.addEventListener('tab-shown', (e) => {
                    if(e.detail.id === 'viewer-view') {
                        requestAnimationFrame(() => {
                            viewer.resize();
                            if (viewer.controls.target.length() === 0) viewer.resetCamera();
                        });
                    }
                    if(e.detail.id === 'settings-view' && ws.isConnected) {
                        if(Object.keys(grblSettings.settings).length === 0) {
                            grblSettings.fetchSettings();
                        }
                    }
                });

                initJogging();
            });

            window.toggleCamera = function() {
                const mode = viewer.toggleCamera();
                document.getElementById('cam-toggle-btn').innerHTML = mode === 'Persp' ? '<i class="bi bi-eye-fill text-secondary"></i> Persp' : '<i class="bi bi-box-fill text-secondary"></i> Ortho';
            };
            window.resetCamera = function() { viewer.resetCamera(); };
            window.sendCmd = function(cmd) { ws.sendCommand(cmd); };
            window.sendRealtime = function(c) { ws.sendRealtime(c); };
            window.clearTerminal = function() { term.clear(); }

            function sendFromInput() {
                const i = document.getElementById('cmdInput');
                const val = i.value.trim();
                if(val) {
                    if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== val) {
                        commandHistory.push(val);
                        if(commandHistory.length > 50) commandHistory.shift();
                    }
                    historyIndex = commandHistory.length;
                    window.sendCmd(val);
                    i.value = '';
                }
            }

            function navigateHistory(direction) {
                if (commandHistory.length === 0) return;
                historyIndex += direction;
                if (historyIndex < 0) historyIndex = 0;
                if (historyIndex > commandHistory.length) historyIndex = commandHistory.length;
                const input = document.getElementById('cmdInput');
                if (historyIndex < commandHistory.length) {
                    input.value = commandHistory[historyIndex];
                } else {
                    input.value = '';
                }
            }

            function initJogging() {
                const btns = document.querySelectorAll('[data-jog]');
                const toggle = document.getElementById('jogContinuous');

                // Restore from Store
                toggle.checked = store.get('jog.continuous');
                document.getElementById('stepSize').disabled = toggle.checked;

                toggle.addEventListener('change', () => {
                    store.set('jog.continuous', toggle.checked);
                    document.getElementById('stepSize').disabled = toggle.checked;
                });

                document.getElementById('stepSize').addEventListener('change', (e) => {
                     store.set('jog.step', parseFloat(e.target.value));
                });

                document.getElementById('feedRate').addEventListener('change', (e) => {
                     store.set('jog.feed', parseFloat(e.target.value));
                });

                btns.forEach(btn => {
                    const dir = btn.dataset.jog;
                    const startJog = (e) => {
                        if(!toggle.checked) return;
                        e.preventDefault();

                        const f = document.getElementById('feedRate').value;
                        const isMm = store.get('general.units') === 'mm';
                        const unit = isMm ? 'G21' : 'G20';
                        const dist = isMm ? '1000' : '50';

                        let move = "";
                        if(dir.includes('X')) move += `X${dir.includes('X-')?'-':''}${dist} `;
                        if(dir.includes('Y')) move += `Y${dir.includes('Y-')?'-':''}${dist} `;
                        if(dir.includes('Z')) move += `Z${dir.includes('Z-')?'-':''}${dist} `;
                        if(dir.includes('A')) move += `A${dir.includes('A-')?'-':''}${dist} `;

                        ws.sendCommand(`$J=G91 ${unit} ${move}F${f}`);
                    };
                    const stopJog = (e) => {
                        if(!toggle.checked) return;
                        ws.sendRealtime('\x85');
                    };
                    const clickJog = () => {
                        if(toggle.checked) return;
                        const s = document.getElementById('stepSize').value;
                        const f = document.getElementById('feedRate').value;
                        const isMm = store.get('general.units') === 'mm';
                        const unit = isMm ? 'G21' : 'G20';

                        let move = "";
                        if(dir.includes('X')) move += `X${dir.includes('X-')?'-':''}${s} `;
                        if(dir.includes('Y')) move += `Y${dir.includes('Y-')?'-':''}${s} `;
                        if(dir.includes('Z')) move += `Z${dir.includes('Z-')?'-':''}${s} `;
                        if(dir.includes('A')) move += `A${dir.includes('A-')?'-':''}${s} `;

                        ws.sendCommand(`$J=G91 ${unit} ${move}F${f}`);
                    };

                    btn.addEventListener('mousedown', startJog);
                    btn.addEventListener('touchstart', startJog);
                    btn.addEventListener('mouseup', stopJog);
                    btn.addEventListener('mouseleave', stopJog);
                    btn.addEventListener('touchend', stopJog);
                    btn.addEventListener('click', clickJog);
                });
            }

            function updateUIConnected(state) {
                const btn = document.getElementById('btn-connect');
                const resetBtn = document.getElementById('btn-reset');

                // ADDED probe-panel-content to list
                const disabledIds = ['machine-controls', 'console-input-area', 'run-job-btn', 'sd-tools', 'sd-breadcrumb', 'settings-toolbar', 'probe-panel-content'];

                if(state) {
                    btn.textContent='Disconnect'; btn.className = "btn btn-danger h-8 text-xs shadow-none";
                    document.getElementById('connection-dot').classList.replace('bg-red-500','bg-green-500');
                    document.getElementById('connection-text').textContent='Online';
                    resetBtn.classList.remove('opacity-50', 'pointer-events-none');
                    disabledIds.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.classList.remove('opacity-50', 'pointer-events-none');
                    });
                    setTimeout(() => ws.sendCommand('$EA'), 500);
                    setTimeout(() => ws.sendCommand('$EE'), 1000);
                    setTimeout(() => sdHandler.refresh(), 1500);
                    setTimeout(() => ws.sendCommand('$EG'), 2000);
                    setTimeout(() => ws.sendCommand('$ES'), 2500);
                    setTimeout(() => ws.sendCommand('$$'), 3000); // Fetch Settings for Ghost Box
                    statusInterval = setInterval(() => ws.sendRealtime('?'), 50);
                } else {
                    if(statusInterval) clearInterval(statusInterval);
                    btn.textContent='Connect'; btn.className = "btn btn-primary h-8 text-xs shadow-none border border-white/10";
                    document.getElementById('connection-dot').classList.replace('bg-green-500','bg-red-500');
                    document.getElementById('connection-text').textContent='Offline';
                    resetBtn.classList.add('opacity-50', 'pointer-events-none');
                    disabledIds.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.classList.add('opacity-50', 'pointer-events-none');
                    });
                }
            }

            function initTerminal() {
                term = new Terminal({ cursorBlink: true, fontSize: 11, fontFamily: '"JetBrains Mono", monospace', theme: { background: '#FFFFFF', foreground: '#333333', cursor: '#333333', selectionBackground: '#E6F4F5' } });
                term.attachCustomKeyEventHandler((arg) => {
                    if (arg.ctrlKey && arg.code === "KeyC" && term.hasSelection()) return false;
                    return true;
                });
                fitAddon = new FitAddon.FitAddon(); term.loadAddon(fitAddon); term.open(document.getElementById('terminal-container')); fitAddon.fit();
            }

            function processLine(line) {
                if(!line) return;
                line = line.trim();
                if (line.startsWith('[PRB:')) {
                    probeHandler.handleProbeResult(line);
                    return;
                }
                if (sdHandler.processLine(line)) return;

                // Handle Settings for Ghost Box
                if (grblSettings.handleLine(line)) {
                    // Update viewer limits if settings are loaded
                    if (viewer && grblSettings.settings['130'] && grblSettings.settings['131'] && grblSettings.settings['132']) {
                        viewer.setMachineLimits(
                            parseFloat(grblSettings.settings['130'].val),
                            parseFloat(grblSettings.settings['131'].val),
                            parseFloat(grblSettings.settings['132'].val)
                        );
                    }
                    return;
                }

                const report = reporter.handleLine(line);
                if (report) {
                    if (typeof report === 'string') term.writeln(report);
                    return;
                }
                if (line.startsWith('<')) {
                    droHandler.parseStatus(line);
                    // Update Viewer WCS for Ghost Box
                    if(viewer) viewer.updateWCS(droHandler.wco);
                    // Update Tool Position
                    if(viewer && droHandler.wpos) viewer.updateToolPosition(droHandler.wpos[0], droHandler.wpos[1], droHandler.wpos[2]);
                    return;
                }
                if (gcodeStreamer.active && (line === 'ok' || line.toLowerCase().startsWith('error:'))) {
                    if (line.toLowerCase().startsWith('error:')) abortGCodeStream(line);
                    else advanceGCodeStream();
                    return;
                }
                term.writeln(line);
            }

            window.runCurrentJob = function() {
                if (!currentGCodeContent || gcodeStreamer.active) {
                    alert("No G-Code loaded in the viewer to run!");
                    return;
                }
                if (!confirm("Are you sure you want to run the job currently loaded in the 3D viewer?")) return;
                gcodeStreamer.lines = currentGCodeContent.split('\n').filter(line => line.trim().length > 0);
                gcodeStreamer.index = 0;
                gcodeStreamer.active = true;
                gcodeStreamer.paused = false;

                // Toggle UI
                document.getElementById('run-job-btn').classList.add('hidden');
                document.getElementById('job-active-controls').classList.remove('hidden');
                document.getElementById('job-active-controls').classList.add('flex');

                term.writeln("\x1b[35m[Job Stream] Starting...\x1b[0m");
                document.getElementById('upload-progress-container').style.display = 'block';
                advanceGCodeStream();
            }

            window.pauseJob = function() {
                if (!gcodeStreamer.active) return;
                const btn = document.getElementById('pause-job-btn');
                gcodeStreamer.paused = !gcodeStreamer.paused;

                if (gcodeStreamer.paused) {
                    ws.sendRealtime('!'); // Feed Hold
                    btn.innerHTML = '<i class="bi bi-play-fill text-lg"></i> Resume';
                    btn.classList.replace('!bg-yellow-100', '!bg-green-100');
                    btn.classList.replace('!text-yellow-800', '!text-green-800');
                    btn.classList.replace('border-yellow-300', 'border-green-300');
                    term.writeln("\x1b[33m[Job Stream] Paused.\x1b[0m");
                } else {
                    ws.sendRealtime('~'); // Cycle Start
                    btn.innerHTML = '<i class="bi bi-pause-fill text-lg"></i> Pause';
                    btn.classList.replace('!bg-green-100', '!bg-yellow-100');
                    btn.classList.replace('!text-green-800', '!text-yellow-800');
                    btn.classList.replace('border-green-300', 'border-yellow-300');
                    term.writeln("\x1b[32m[Job Stream] Resuming...\x1b[0m");
                }
            }

            window.stopJob = function() {
                if (!gcodeStreamer.active) return;
                if (!confirm("Stop Job? This will reset the machine.")) return;
                ws.sendRealtime('\x18'); // Ctrl-x (Soft Reset)
                abortGCodeStream("User Stopped");
            }

            function advanceGCodeStream() {
                if (!gcodeStreamer.active) return;
                if (gcodeStreamer.index >= gcodeStreamer.lines.length) {
                    finishGCodeStream();
                    return;
                }
                const line = gcodeStreamer.lines[gcodeStreamer.index];
                ws.sendCommand(line);
                gcodeStreamer.index++;
                const pct = Math.round((gcodeStreamer.index / gcodeStreamer.lines.length) * 100);
                document.getElementById('upload-progress-bar').style.width = `${pct}%`;
                document.getElementById('upload-pct').textContent = `${pct}%`;
            }

            function finishGCodeStream() {
                gcodeStreamer.active = false;
                term.writeln("\x1b[32m[Job Stream] Complete.\x1b[0m");
                resetJobUI();
            }
            function abortGCodeStream(error) {
                gcodeStreamer.active = false;
                term.writeln(`\x1b[31m[Job Stream] Aborted: ${error}\x1b[0m`);
                resetJobUI();
            }

            function resetJobUI() {
                document.getElementById('upload-progress-container').style.display = 'none';
                document.getElementById('run-job-btn').classList.remove('hidden');
                document.getElementById('job-active-controls').classList.add('hidden');
                document.getElementById('job-active-controls').classList.remove('flex');

                // Reset Pause Button State
                const btn = document.getElementById('pause-job-btn');
                btn.innerHTML = '<i class="bi bi-pause-fill text-lg"></i> Pause';
                btn.className = "overlay-btn !bg-yellow-100 !text-yellow-800 border-yellow-300 shadow-lg";
            }
        </script>
    </body>
    </html>
