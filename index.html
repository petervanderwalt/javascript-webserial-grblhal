<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSerial CNC Control</title>

    <!-- Fonts: Nunito & Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">

    <!-- Icons & Xterm -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
          theme: {
              extend: {
                  colors: {
                      primary: {
                          DEFAULT: '#FFD949',
                          dark: '#D7B232',
                          light: '#FFF2AE'
                      }, // Solar Yellow
                      secondary: {
                          DEFAULT: '#6A6B6A',
                          dark: '#383838',
                          light: '#D9D9D8'
                      }, // Techno Graphite
                      grey: {
                          dark: '#2F373C',
                          DEFAULT: '#909090',
                          light: '#E2E8F0',
                          bg: '#F8F9FA'
                      },
                      surface: '#FFFFFF'
                  },
                  fontFamily: {
                      heading: ['Nunito', 'sans-serif'],
                      body: ['Roboto', 'sans-serif'],
                      mono: ['JetBrains Mono', 'monospace']
                  },
                  boxShadow: {
                      'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                      'card': '0 2px 4px rgba(0,0,0,0.05)'
                  }
              }
          }
      }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            /* Layout */
            .app-container { @apply flex h-screen w-screen overflow-hidden bg-grey-bg text-grey-dark font-body; }
            .sidebar { @apply w-[420px] flex-shrink-0 bg-white border-r border-grey-light flex flex-col z-30 shadow-soft; }

            /* Buttons */
            .btn { @apply px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed; }
            .btn-primary { @apply bg-primary text-black hover:bg-primary-dark shadow-sm; }
            .btn-secondary { @apply bg-white border-2 border-grey-light text-grey-dark hover:border-secondary hover:text-secondary; }
            .btn-danger { @apply bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white; }
            .btn-ghost { @apply text-grey hover:text-primary hover:bg-grey-bg rounded p-1; }
            .btn-icon { @apply p-2 rounded-md hover:bg-grey-bg transition-colors; }

            /* Inputs */
            .input-field { @apply w-full rounded-md border-2 border-grey-light bg-grey-bg px-3 py-2 text-sm font-bold text-grey-dark focus:border-secondary focus:bg-white outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed; }

            /* DRO Styles (Updated for Ultra Compactness & Contrast) */
            .dro-panel { @apply bg-secondary-light text-grey-dark rounded-lg p-1.5 shadow-sm mb-3 border border-grey-light; }
            .dro-row { @apply flex items-center justify-between py-0; }
            .dro-axis { @apply font-heading text-base font-black w-5 text-grey-dark; }
            .dro-value { @apply font-mono text-xl tracking-tight text-right flex-1 mx-1 font-black text-black; }
            .dro-val-mach { @apply font-mono text-[10px] text-grey font-bold tracking-tight mt-0.5 block text-right leading-none; }
            .dro-btn { @apply text-[9px] uppercase font-bold text-grey-dark hover:text-black bg-white border border-grey-light hover:border-primary px-1.5 py-0 rounded shadow-sm transition-colors; }

            /* Jog Styles */
            .jog-wrapper { @apply flex gap-4 justify-center; }
            .jog-pad { @apply grid grid-cols-3 gap-2; }
            .jog-btn { @apply w-14 h-14 bg-white border-2 border-grey-light rounded-xl text-2xl text-grey-dark hover:border-primary hover:text-primary hover:bg-primary-light active:bg-primary active:text-black transition-all shadow-sm flex items-center justify-center; }
            .jog-extra-col { @apply flex flex-col gap-2; }
            .jog-btn-extra { @apply w-14 h-[50px] bg-white border-2 border-grey-light rounded-xl text-lg font-bold text-grey-dark hover:border-secondary hover:text-secondary hover:bg-secondary-light active:bg-secondary active:text-white transition-all shadow-sm flex items-center justify-center; }

            /* Console */
            .console-wrapper { @apply flex-1 bg-white rounded-lg overflow-hidden p-2 shadow-inner border border-grey-light relative; }

            /* Tabs */
            .tab-nav { @apply flex bg-white border-b border-grey-light px-6 gap-2 pt-2; }
            .tab-btn { @apply py-3 px-4 text-sm font-bold text-grey transition-all flex items-center hover:text-secondary-dark; }
            .tab-btn.active { @apply bg-secondary-dark text-white; }

            /* Viewer Overlay */
            .viewer-controls { @apply absolute top-4 right-4 flex flex-col gap-2 z-20; }
            .overlay-btn { @apply bg-white/90 backdrop-blur shadow-md px-3 py-2 rounded-lg text-xs font-bold text-grey-dark hover:text-primary hover:bg-white transition-all flex items-center gap-2; }
        }

        .xterm-viewport { overflow-y: auto !important; }
    </style>


    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }
    </script>
</head>
<body>

    <div class="app-container">

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Header -->
            <div class="h-11 flex items-center px-4 bg-secondary-dark text-white justify-between shadow-md z-20">
                <div class="flex items-center gap-3">
                    <a href="#"><img src="logo.png" alt="CNC Control" class="h-10"></a>
                    <!-- Connection Status Pill -->
                    <div class="flex items-center bg-black/20 px-2.5 py-0.5 rounded-full border border-white/10 text-[9px] font-bold uppercase tracking-wider">
                        <div id="connection-dot" class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                        <span id="connection-text">Offline</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <!-- Reset Button -->
                    <button id="btn-reset" class="btn h-8 text-xs shadow-none border border-white/10 opacity-50 pointer-events-none transition-opacity" onclick="sendRealtime('\x18')" title="Soft Reset"><i class="bi bi-exclamation-octagon-fill"></i> Reset</button>
                    <!-- Connect Button -->
                    <button id="btn-connect" class="btn btn-primary h-8 text-xs shadow-none border border-white/10">Connect</button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4">

                <!-- Machine Controls Wrapper (Disabled when offline) -->
                <div id="machine-controls" class="flex flex-col gap-4 opacity-50 pointer-events-none transition-opacity duration-200">

                    <!-- DRO (Teal Design) -->
                    <div class="dro-panel">
                        <!-- Toggle Switch Header -->
                         <div class="flex justify-between items-center mb-1 pb-1 border-b border-grey-light/50">
                            <!-- WCS Select (Updated to White BG / Dark Text) -->
                            <div class="flex items-center gap-1">
                                <span class="text-[10px] font-bold uppercase opacity-60">WCS</span>
                                <select class="bg-white text-secondary-dark text-[10px] font-bold uppercase border border-transparent shadow-sm rounded px-1 py-0 outline-none hover:bg-white/90 cursor-pointer" onchange="window.dro.setWCS(this.value)">
                                    <option value="G54" selected>G54</option>
                                    <option value="G55">G55</option>
                                    <option value="G56">G56</option>
                                    <option value="G57">G57</option>
                                    <option value="G58">G58</option>
                                    <option value="G59">G59</option>
                                    <option value="G59.1">G59.1</option>
                                    <option value="G59.2">G59.2</option>
                                    <option value="G59.3">G59.3</option>
                                </select>
                            </div>

                            <!-- Units Toggle -->
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="unitToggle" class="sr-only peer" checked onchange="window.dro.toggleUnits()">
                                <!-- Removed peer-checked:bg-primary, used bg-secondary (dark grey) -->
                                <div class="relative w-7 h-4 bg-grey-light/50 border border-grey-light peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:start-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-secondary"></div>
                                <span class="ms-1.5 text-[9px] font-bold text-secondary uppercase w-3" id="unitLabel">MM</span>
                            </label>
                        </div>

                        <!-- X -->
                        <div class="dro-row">
                            <span class="dro-axis">X</span>
                            <div class="flex flex-col items-end flex-1 mx-2">
                                <span id="dro-x" class="dro-value">0.000</span>
                                <span id="dro-x-m" class="dro-val-mach">0.000</span>
                            </div>
                            <button class="dro-btn" onclick="window.dro.setZero('X')">Zero</button>
                        </div>
                        <!-- Y -->
                        <div class="dro-row">
                            <span class="dro-axis">Y</span>
                            <div class="flex flex-col items-end flex-1 mx-2">
                                <span id="dro-y" class="dro-value">0.000</span>
                                <span id="dro-y-m" class="dro-val-mach">0.000</span>
                            </div>
                            <button class="dro-btn" onclick="window.dro.setZero('Y')">Zero</button>
                        </div>
                        <!-- Z -->
                        <div class="dro-row">
                            <span class="dro-axis">Z</span>
                            <div class="flex flex-col items-end flex-1 mx-2">
                                <span id="dro-z" class="dro-value">0.000</span>
                                <span id="dro-z-m" class="dro-val-mach">0.000</span>
                            </div>
                            <button class="dro-btn" onclick="window.dro.setZero('Z')">Zero</button>
                        </div>
                        <!-- A -->
                        <div class="dro-row hidden">
                            <span class="dro-axis">A</span>
                            <div class="flex flex-col items-end flex-1 mx-2">
                                <span id="dro-a" class="dro-value">0.000</span>
                                <span id="dro-a-m" class="dro-val-mach">0.000</span>
                            </div>
                            <button class="dro-btn" onclick="window.dro.setZero('A')">Zero</button>
                        </div>

                        <!-- Footer (State & Global Buttons) -->
                        <div class="flex justify-between items-center mt-1 pt-1 border-t border-grey-light/50">
                            <!-- Machine Status (Left) -->
                            <span id="machine-state" class="machine-status-pill">Unknown</span>

                            <!-- Global Actions (Right) -->
                            <div class="flex gap-1.5">
                                <button class="dro-btn !bg-primary !text-black !border-primary hover:!bg-primary-dark" onclick="window.dro.home()" title="Home All ($H)"><i class="bi bi-house-door-fill mr-1"></i> HOME</button>
                                <button class="dro-btn" onclick="window.dro.setZero('XYZ')">ZERO ALL</button>
                                <button class="dro-btn" onclick="window.dro.goXY0()">GO XY 0</button>
                            </div>
                        </div>
                    </div>

                    <!-- Jog Controls -->
                    <div class="bg-white p-4 rounded-xl border border-grey-light shadow-card">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-bold text-grey uppercase tracking-wider">Manual Control</span>

                        </div>

                        <div class="jog-wrapper">
                            <!-- XY Pad -->
                            <div class="jog-pad">
                                <button class="jog-btn rounded-tl-2xl" data-jog="X-Y+"><i class="bi bi-arrow-up-left"></i></button>
                                <button class="jog-btn" data-jog="Y+"><i class="bi bi-caret-up-fill text-2xl"></i></button>
                                <button class="jog-btn rounded-tr-2xl" data-jog="X+Y+"><i class="bi bi-arrow-up-right"></i></button>

                                <button class="jog-btn" data-jog="X-"><i class="bi bi-caret-left-fill text-2xl"></i></button>
                                <div class="w-14 h-14 flex items-center justify-center">
                                    <i class="bi bi-dpad-fill text-3xl text-grey-light"></i>
                                </div>
                                <button class="jog-btn" data-jog="X+"><i class="bi bi-caret-right-fill text-2xl"></i></button>

                                <button class="jog-btn rounded-bl-2xl" data-jog="X-Y-"><i class="bi bi-arrow-down-left"></i></button>
                                <button class="jog-btn" data-jog="Y-"><i class="bi bi-caret-down-fill text-2xl"></i></button>
                                <button class="jog-btn rounded-br-2xl" data-jog="X+Y-"><i class="bi bi-arrow-down-right"></i></button>
                            </div>

                            <!-- Right Column: Unlock + Z & A, CONTINUOUS -->
                            <div class="flex flex-col gap-2 w-32">
                                <!-- Unlock Button -->
                                <button class="btn btn-secondary w-full h-8 text-xs justify-center" onclick="sendCmd('$X')" title="Unlock ($X)"><i class="bi bi-unlock-fill"></i> Unlock</button>

                                <!-- Z & A Buttons -->
                                <div class="flex gap-2 justify-center">
                                     <!-- Z Pad -->
                                    <div class="jog-extra-col">
                                        <button class="jog-btn-extra rounded-t-2xl" data-jog="Z+">Z+</button>
                                        <button class="jog-btn-extra rounded-b-2xl" data-jog="Z-">Z-</button>
                                    </div>
                                     <!-- A Pad -->
                                    <div class="jog-extra-col">
                                        <button class="jog-btn-extra rounded-t-2xl" data-jog="A+">A+</button>
                                        <button class="jog-btn-extra rounded-b-2xl" data-jog="A-">A-</button>
                                    </div>
                                </div>

                                <!-- Continuous Toggle -->
                                <label class="inline-flex justify-center cursor-pointer gap-2">
                                    <span class="text-[10px] font-bold text-grey uppercase">Incr</span>
                                    <input type="checkbox" id="jogContinuous" class="sr-only peer">
                                    <div class="relative w-7 h-4 bg-grey-light/50 border border-grey-light peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:start-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-secondary"></div>
                                    <span class="text-[10px] font-bold text-grey uppercase">Cont</span>
                                </label>
                            </div>
                        </div>

                        <!-- Step/Feed -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-[10px] font-bold text-grey uppercase">Dist</span>
                                <select id="stepSize" class="input-field pl-10 text-right">
                                    <option value="0.1">0.1</option>
                                    <option value="1">1</option>
                                    <option value="10" selected>10</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-[10px] font-bold text-grey uppercase">Feed</span>
                                <input type="number" id="feedRate" value="1000" class="input-field pl-10 text-right">
                            </div>
                        </div>
                    </div>
                </div> <!-- End Machine Controls -->

                <!-- Console (Light Mode) -->
                <div class="flex-1 flex flex-col min-h-[200px]">
                    <div class="flex justify-between items-center mb-1 px-1">
                        <span class="text-[10px] font-bold text-grey uppercase tracking-wider">Console</span>
                        <button class="btn-ghost text-xs" onclick="clearTerminal()"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="console-wrapper">
                        <div id="terminal-container" class="w-full h-full"></div>
                    </div>
                    <!-- Console Input (Disabled when offline) -->
                    <div id="console-input-area" class="flex gap-2 mt-2 opacity-50 pointer-events-none transition-opacity duration-200">
                        <input type="text" id="cmdInput" class="input-field font-mono" placeholder="G-Code...">
                        <button id="btnSend" class="btn btn-secondary px-3"><i class="bi bi-send-fill text-xs"></i></button>
                    </div>
                </div>

            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-grey-bg relative overflow-hidden">

            <!-- Navigation -->
            <div class="tab-nav p-0 m-0">
                <button class="tab-btn active" onclick="switchTab('viewer-view', this)">3D Preview</button>
                <button class="tab-btn" onclick="switchTab('sd-view', this)">
                    SD Card
                    <span id="sd-badge" class="hidden ml-2 bg-primary text-black text-[10px] font-bold px-1.5 py-0 rounded-full">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('settings-view', this)">Settings</button>
            </div>

            <!-- Content -->
            <div class="flex-1 relative overflow-hidden"> <!-- Added overflow-hidden here for strict constraint -->

                <!-- 3D Viewer (Default) -->
                <div id="viewer-view" class="tab-pane w-full h-full relative bg-grey-light/30">
                    <div id="viewer-container" class="absolute inset-0"></div>

                    <!-- Loading Overlay -->
                    <div id="loading-overlay" class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                        <div class="bg-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                            <div class="w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                            <span class="font-bold text-grey-dark">Parsing G-Code...</span>
                        </div>
                    </div>

                    <!-- Viewer Controls -->
                    <div class="viewer-controls">
                        <!-- Run Job (Disabled when offline) -->
                        <button id="run-job-btn" class="overlay-btn !bg-primary !text-secondary-dark hover:!bg-primary-dark shadow-lg opacity-50 pointer-events-none transition-opacity duration-200" onclick="runCurrentJob()">
                            <i class="bi bi-play-fill text-lg"></i> Run Job
                        </button>
                        <button class="overlay-btn mt-4" onclick="resetCamera()">
                            <i class="bi bi-camera-video-fill text-secondary"></i> Reset
                        </button>
                        <button class="overlay-btn" onclick="toggleCamera()" id="cam-toggle-btn">
                            <i class="bi bi-box-fill text-secondary"></i> Ortho
                        </button>
                        <label class="overlay-btn cursor-pointer">
                            <i class="bi bi-folder2-open text-secondary"></i> Open File
                            <input type="file" id="gcode-file-input" hidden accept=".gcode,.nc,.gc,.ngc">
                        </label>
                    </div>
                </div>

                <!-- SD Card -->
                <div id="sd-view" class="tab-pane hidden w-full h-full p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sd-card-fill"></i> SD Card
                                </h2>
                                <p class="text-sm text-grey">Manage files stored on your controller.</p>
                            </div>
                            <!-- SD Actions (Disabled when offline) -->
                            <div id="sd-tools" class="flex gap-2 opacity-50 pointer-events-none transition-opacity duration-200">
                                <button class="btn btn-primary shadow-soft" onclick="document.getElementById('sd-upload-input').click()">
                                    <i class="bi bi-cloud-upload-fill"></i> Upload
                                </button>
                                <button class="btn btn-secondary shadow-soft" onclick="window.sdHandler.refresh()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <input type="file" id="sd-upload-input" hidden>
                        </div>

                        <!-- Breadcrumb (Disabled when offline) -->
                        <div id="sd-breadcrumb" class="bg-white border border-grey-light rounded-lg p-3 mb-4 flex items-center gap-3 shadow-card opacity-50 pointer-events-none transition-opacity duration-200">
                            <button class="btn-icon text-grey-dark" onclick="window.sdHandler.upLevel()">
                                <i class="bi bi-arrow-90deg-up"></i>
                            </button>
                            <span class="text-grey-light">|</span>
                            <span id="sd-current-path" class="font-mono font-bold text-grey-dark">/</span>
                        </div>

                        <!-- Upload Progress -->
                        <div id="upload-progress-container" class="hidden mb-6 bg-white p-4 rounded-lg border border-grey-light shadow-soft">
                            <div class="flex justify-between text-xs font-bold text-grey mb-2 uppercase">
                                <span>Transferring...</span>
                                <span id="upload-pct">0%</span>
                            </div>
                            <div class="h-2 w-full bg-grey-bg rounded-full overflow-hidden">
                                <div id="upload-progress-bar" class="h-full bg-primary transition-all duration-300 w-0"></div>
                            </div>
                        </div>

                        <!-- File Table (Restored White) -->
                        <div class="bg-white border border-grey-light rounded-xl shadow-soft overflow-hidden">
                            <table class="w-full text-left text-sm" id="sd-table">
                                <thead class="bg-grey-bg border-b border-grey-light text-grey uppercase text-[10px] tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 font-bold">Filename</th>
                                        <th class="px-6 py-4 font-bold">Size</th>
                                        <th class="px-6 py-4 font-bold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-grey-light">
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center text-grey italic">
                                            Click Refresh to load files...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Grbl Settings -->
                <div id="settings-view" class="tab-pane hidden w-full h-full p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sliders"></i> Machine Settings
                                </h2>
                                <p class="text-sm text-grey">Configure GrblHAL firmware parameters.</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary" onclick="window.grblSettings.fetchSettings()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-secondary" onclick="window.grblSettings.backup()">
                                    <i class="bi bi-download"></i> Backup
                                </button>
                                <button class="btn btn-secondary" onclick="document.getElementById('settings-restore-input').click()">
                                    <i class="bi bi-upload"></i> Restore
                                </button>
                                <input type="file" id="settings-restore-input" hidden onchange="window.grblSettings.restore(this.files[0])">

                                <button class="btn btn-primary" onclick="window.grblSettings.saveChanges()">
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                            </div>
                        </div>

                        <!-- Settings Table Container (Removed clipping/styling to fix scroll) -->
                        <div id="grbl-settings-container">
                            <!-- populated by js -->
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        function switchTab(targetId, btn) {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(targetId);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if(targetId === 'viewer-view') {
                window.dispatchEvent(new Event('resize'));
                window.dispatchEvent(new CustomEvent('tab-shown', { detail: { id: targetId } }));
            }
        }
    </script>

    <script type="module">
        import { WebSerial } from './webserial.js';
        import { GCodeViewer } from './3dview.js';
        import { SDCardHandler } from './sdcard.js';
        import { AlarmsAndErrors } from './alarms_and_errors.js';
        import { DROHandler } from './DRO.js';
        import { GrblSettings } from './grbl_settings.js';

        // Globals
        const ws = new WebSerial();
        const viewer = new GCodeViewer('viewer-container', 'loading-overlay');
        const reporter = new AlarmsAndErrors();
        window.viewer = viewer;

        let term, fitAddon, statusInterval;

        let currentGCodeContent = null;
        let gcodeStreamer = { active: false, lines: [], index: 0 };

        // Command History
        let commandHistory = [];
        let historyIndex = -1;

        // Handler Instantiation
        let sdHandler = null;
        let droHandler = null;
        let grblSettings = null;

        document.addEventListener('DOMContentLoaded', () => {
            initTerminal();

            // Initialize Helpers
            droHandler = new DROHandler(ws, term);
            window.dro = droHandler;

            grblSettings = new GrblSettings(ws, term);
            grblSettings.init('grbl-settings-container');
            window.grblSettings = grblSettings;

            sdHandler = new SDCardHandler(ws, term, viewer, {
                onDownloadComplete: (content) => {
                    currentGCodeContent = content;
                },
                switchToViewer: () => {
                    switchTab('viewer-view');
                },
                pausePolling: () => {
                    if (statusInterval) clearInterval(statusInterval);
                },
                resumePolling: () => {
                    statusInterval = setInterval(() => ws.sendRealtime('?'), 200);
                }
            });
            window.sdHandler = sdHandler;

            ws.on('connect', () => updateUIConnected(true));
            ws.on('disconnect', () => updateUIConnected(false));
            ws.on('line', (line) => processLine(line));
            ws.on('sent', (line) => {
                // Prevent console flood during bulk operations
                if (window.sdHandler?.isDownloading) return;
                if (gcodeStreamer.active) return;
                // Don't log automated status queries (though sendCommand shouldn't be used for '?' usually, sendRealtime is)
                if (line === '?' || line === '$G') return;

                term.writeln(`\x1b[2m> ${line}\x1b[0m`);
            });

            const connectBtn = document.getElementById('btn-connect');
            connectBtn.addEventListener('click', () => {
                if(ws.isConnected) {
                    ws.disconnect();
                } else {
                    ws.connect(115200);
                }
            });

            document.getElementById('btnSend').addEventListener('click', sendFromInput);

            // CMD Input Keydown: Enter + Up/Down History
            document.getElementById('cmdInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendFromInput();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateHistory(-1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateHistory(1);
                }
            });

            document.getElementById('gcode-file-input').addEventListener('change', (e) => viewer.loadLocalFile(e.target.files[0]));
            document.getElementById('sd-upload-input').addEventListener('change', (e) => sdHandler.startUpload(e.target.files[0]));

            window.addEventListener('resize', () => { fitAddon.fit(); viewer.resize(); });
            window.addEventListener('tab-shown', (e) => {
                if(e.detail.id === 'viewer-view') {
                    requestAnimationFrame(() => {
                        viewer.resize();
                        if (viewer.controls.target.length() === 0) viewer.resetCamera();
                    });
                }
                if(e.detail.id === 'settings-view' && ws.isConnected) {
                    // Auto fetch settings if empty
                    if(Object.keys(grblSettings.settings).length === 0) {
                        grblSettings.fetchSettings();
                    }
                }
            });

            initJogging();
        });

        window.toggleCamera = function() {
            const mode = viewer.toggleCamera();
            document.getElementById('cam-toggle-btn').innerHTML = mode === 'Persp' ? '<i class="bi bi-eye-fill text-secondary"></i> Persp' : '<i class="bi bi-box-fill text-secondary"></i> Ortho';
        };
        window.resetCamera = function() { viewer.resetCamera(); };
        window.sendCmd = function(cmd) { ws.sendCommand(cmd); }; // Manual log removed
        window.sendRealtime = function(c) { ws.sendRealtime(c); };

        // jog logic moved to initJogging
        window.clearTerminal = function() { term.clear(); }

        function sendFromInput() {
            const i = document.getElementById('cmdInput');
            const val = i.value.trim();
            if(val) {
                // Add to history if unique at the end
                if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== val) {
                    commandHistory.push(val);
                    if(commandHistory.length > 50) commandHistory.shift(); // Limit to 50
                }
                historyIndex = commandHistory.length; // Reset index to bottom

                window.sendCmd(val);
                i.value = '';
            }
        }

        function navigateHistory(direction) {
            if (commandHistory.length === 0) return;

            historyIndex += direction;
            if (historyIndex < 0) historyIndex = 0;
            if (historyIndex > commandHistory.length) historyIndex = commandHistory.length;

            const input = document.getElementById('cmdInput');
            if (historyIndex < commandHistory.length) {
                input.value = commandHistory[historyIndex];
            } else {
                input.value = '';
            }
        }

        function initJogging() {
            const btns = document.querySelectorAll('[data-jog]');
            const toggle = document.getElementById('jogContinuous');

            // Continuous Loop Timer
            let jogInterval = null;
            let currentJogCmd = null;

            // Load Saved State
            toggle.addEventListener('change', () => {
                localStorage.setItem('grbl_jog_cont', toggle.checked);
                document.getElementById('stepSize').disabled = toggle.checked; // Disabled in continuous mode
            });

            document.getElementById('stepSize').addEventListener('change', (e) => {
                 localStorage.setItem('grbl_step_size', e.target.value);
            });

            document.getElementById('feedRate').addEventListener('change', (e) => {
                 localStorage.setItem('grbl_feed_rate', e.target.value);
            });

            btns.forEach(btn => {
                const dir = btn.dataset.jog;

                // Mouse Down / Touch Start (Continuous)
                const startJog = (e) => {
                    if(!toggle.checked) return;
                    e.preventDefault();
                    if(jogInterval) return; // Already running

                    const f = document.getElementById('feedRate').value;
                    const isMm = document.getElementById('unitToggle').checked;
                    const unit = isMm ? 'G21' : 'G20';
                    const dist = isMm ? '1000' : '50'; // Large distance for continuous

                    // Construct command
                    let move = "";
                    if(dir.includes('X')) move += `X${dir.includes('X-')?'-':''}${dist} `;
                    if(dir.includes('Y')) move += `Y${dir.includes('Y-')?'-':''}${dist} `;
                    if(dir.includes('Z')) move += `Z${dir.includes('Z-')?'-':''}${dist} `;
                    if(dir.includes('A')) move += `A${dir.includes('A-')?'-':''}${dist} `;

                    // Send initial long move
                    ws.sendCommand(`$J=G91 ${unit} ${move}F${f}`);
                };

                // Mouse Up / Leave (Stop Continuous)
                const stopJog = (e) => {
                    if(!toggle.checked) return;
                    // Send Cancel immediately
                    ws.sendRealtime('\x85');
                };

                // Click (Incremental)
                const clickJog = () => {
                    if(toggle.checked) return; // Ignore clicks in continuous mode
                    const s = document.getElementById('stepSize').value;
                    const f = document.getElementById('feedRate').value;
                    const isMm = document.getElementById('unitToggle').checked;
                    const unit = isMm ? 'G21' : 'G20';

                    let move = "";
                    if(dir.includes('X')) move += `X${dir.includes('X-')?'-':''}${s} `;
                    if(dir.includes('Y')) move += `Y${dir.includes('Y-')?'-':''}${s} `;
                    if(dir.includes('Z')) move += `Z${dir.includes('Z-')?'-':''}${s} `;
                    if(dir.includes('A')) move += `A${dir.includes('A-')?'-':''}${s} `;

                    ws.sendCommand(`$J=G91 ${unit} ${move}F${f}`);
                };

                btn.addEventListener('mousedown', startJog);
                btn.addEventListener('touchstart', startJog);

                btn.addEventListener('mouseup', stopJog);
                btn.addEventListener('mouseleave', stopJog);
                btn.addEventListener('touchend', stopJog);

                btn.addEventListener('click', clickJog);
            });
        }

        function updateUIConnected(state) {
            const btn = document.getElementById('btn-connect');
            const resetBtn = document.getElementById('btn-reset');

            // Elements to disable/enable based on connection
            const disabledIds = ['machine-controls', 'console-input-area', 'run-job-btn', 'sd-tools', 'sd-breadcrumb', 'settings-toolbar'];

            if(state) {
                btn.textContent='Disconnect'; btn.className = "btn btn-danger h-8 text-xs shadow-none";
                document.getElementById('connection-dot').classList.replace('bg-red-500','bg-green-500');
                document.getElementById('connection-text').textContent='Online';

                // Enable Reset Button
                resetBtn.classList.remove('opacity-50', 'pointer-events-none');

                // Enable controls
                disabledIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('opacity-50', 'pointer-events-none');
                });

                setTimeout(() => ws.sendCommand('$EA'), 500);
                setTimeout(() => ws.sendCommand('$EE'), 1000);
                // Auto-refresh SD
                setTimeout(() => sdHandler.refresh(), 1500);
                setTimeout(() => ws.sendCommand('$EG'), 2000);
                setTimeout(() => ws.sendCommand('$ES'), 2500);
                statusInterval = setInterval(() => ws.sendRealtime('?'), 200);
            } else {
                if(statusInterval) clearInterval(statusInterval);
                btn.textContent='Connect'; btn.className = "btn btn-primary h-8 text-xs shadow-none border border-white/10";
                document.getElementById('connection-dot').classList.replace('bg-green-500','bg-red-500');
                document.getElementById('connection-text').textContent='Offline';

                // Disable Reset Button
                resetBtn.classList.add('opacity-50', 'pointer-events-none');

                // Disable controls
                disabledIds.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('opacity-50', 'pointer-events-none');
                });
            }
        }

        // --- Console: Light Theme ---
        function initTerminal() {
            term = new Terminal({ cursorBlink: true, fontSize: 11, fontFamily: '"JetBrains Mono", monospace', theme: { background: '#FFFFFF', foreground: '#333333', cursor: '#333333', selectionBackground: '#E6F4F5' } });

            // Allow Ctrl+C to copy
            term.attachCustomKeyEventHandler((arg) => {
                if (arg.ctrlKey && arg.code === "KeyC" && term.hasSelection()) {
                    return false; // Force browser copy
                }
                return true;
            });

            fitAddon = new FitAddon.FitAddon(); term.loadAddon(fitAddon); term.open(document.getElementById('terminal-container')); fitAddon.fit();
        }

        function processLine(line) {
            if(!line) return;
            line = line.trim();

            // 1. Delegate to SD Handler first
            if (sdHandler.processLine(line)) return;

            // 2. Delegate to Settings Handler
            if (grblSettings.handleLine(line)) return;

            // 3. Delegate to Alarms & Errors
            const report = reporter.handleLine(line);
            if (report) {
                if (typeof report === 'string') term.writeln(report);
                return;
            }

            // 4. Delegate to DRO (Status Parsing)
            if (line.startsWith('<')) {
                droHandler.parseStatus(line);
                return;
            }

            // 5. G-Code Streaming Handler
            if (gcodeStreamer.active && (line === 'ok' || line.toLowerCase().startsWith('error:'))) {
                if (line.toLowerCase().startsWith('error:')) {
                    abortGCodeStream(line);
                } else {
                    advanceGCodeStream();
                }
                return;
            }

            // 6. Standard Output
            term.writeln(line);
        }

        // --- G-CODE STREAMER ---
        window.runCurrentJob = function() {
            if (!currentGCodeContent || gcodeStreamer.active) {
                alert("No G-Code loaded in the viewer to run!");
                return;
            }
            if (!confirm("Are you sure you want to run the job currently loaded in the 3D viewer?")) return;

            gcodeStreamer.lines = currentGCodeContent.split('\n').filter(line => line.trim().length > 0);
            gcodeStreamer.index = 0;
            gcodeStreamer.active = true;

            term.writeln("\x1b[35m[Job Stream] Starting...\x1b[0m");
            document.getElementById('upload-progress-container').style.display = 'block';

            // Start the stream
            advanceGCodeStream();
        }

        function advanceGCodeStream() {
            if (!gcodeStreamer.active) return;
            if (gcodeStreamer.index >= gcodeStreamer.lines.length) {
                finishGCodeStream();
                return;
            }

            const line = gcodeStreamer.lines[gcodeStreamer.index];
            ws.sendCommand(line);
            gcodeStreamer.index++;

            const pct = Math.round((gcodeStreamer.index / gcodeStreamer.lines.length) * 100);
            document.getElementById('upload-progress-bar').style.width = `${pct}%`;
            document.getElementById('upload-pct').textContent = `${pct}%`;
        }

        function finishGCodeStream() {
            gcodeStreamer.active = false;
            term.writeln("\x1b[32m[Job Stream] Complete.\x1b[0m");
            document.getElementById('upload-progress-container').style.display = 'none';
        }
        function abortGCodeStream(error) {
            gcodeStreamer.active = false;
            term.writeln(`\x1b[31m[Job Stream] Aborted: ${error}\x1b[0m`);
            document.getElementById('upload-progress-container').style.display = 'none';
        }
    </script>
</body>
</html>
