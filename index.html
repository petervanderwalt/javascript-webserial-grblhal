<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSerial CNC Control</title>
    <!-- Prevent favicon 404 error -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <!-- Fonts: Nunito & Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;800&display=swap"
        rel="stylesheet">

    <!-- Icons & Xterm -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <!-- Theme Engine -->
    <link id="theme-stylesheet" rel="stylesheet" href="">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: 'var(--color-primary, #FFD949)',
                            dark: 'var(--color-primary-dark, #D7B232)',
                            light: 'var(--color-primary-light, #FFF2AE)'
                        },
                        secondary: {
                            DEFAULT: 'var(--color-secondary, #6A6B6A)',
                            dark: 'var(--color-secondary-dark, #383838)',
                            light: 'var(--color-secondary-light, #B0B0AF)'
                        },
                        grey: {
                            dark: 'var(--color-grey-dark, #2F373C)',
                            DEFAULT: 'var(--color-grey, #6B6B6B)',
                            light: 'var(--color-grey-light, #CBD5E1)',
                            bg: 'var(--color-bg, #EDF2F7)'
                        },
                        surface: 'var(--color-surface, #FFFFFF)',
                        // CNC Standard Axis Colors
                        axis: {
                            x: 'var(--color-axis-x, #EF4444)',
                            y: 'var(--color-axis-y, #22C55E)',
                            z: 'var(--color-axis-z, #3B82F6)',
                            a: 'var(--color-axis-a, #F59E0B)'
                        }
                    },
                    fontFamily: {
                        heading: ['Nunito', 'sans-serif'],
                        body: ['Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.1)',
                        'card': '0 2px 4px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            /* Layout - Mobile Responsive */
            .app-container { @apply flex flex-col md:flex-row h-screen w-screen overflow-hidden bg-grey-bg text-grey-dark font-body relative; }

            /* Unified Machine Sidebar (Left) */
            .machine-sidebar {
                @apply w-full md:w-80 lg:w-96 flex-shrink-0 bg-white border-r border-grey-light flex flex-col shadow-soft;
                @apply fixed md:relative inset-y-0 left-0 z-50 transform transition-transform duration-300 ease-in-out;
                @apply -translate-x-full md:translate-x-0;
            }
            .machine-sidebar.open { @apply translate-x-0; }

            /* Sidebar Overlay */
            .sidebar-overlay {
                @apply md:hidden fixed inset-0 bg-black/60 z-40 backdrop-blur-sm transition-opacity duration-300;
            }

            /* Buttons */
            .btn { @apply px-4 py-2 rounded-lg font-bold text-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed select-none; }
            .btn-primary { @apply bg-primary text-black hover:bg-primary-dark shadow-sm; }
            .btn-secondary { @apply bg-white border-2 border-grey-light text-grey-dark hover:border-secondary hover:text-secondary; }
            .btn-danger { @apply bg-red-50 text-red-600 border border-red-200 hover:bg-red-600 hover:text-white; }
            .btn-ghost { @apply text-grey hover:text-primary hover:bg-grey-bg rounded p-1; }
            .btn-icon { @apply p-2 rounded-md hover:bg-grey-bg transition-colors; }

            /* Overrides Button */
            .btn-ovr { @apply h-9 md:h-7 w-full bg-grey-light hover:bg-secondary hover:text-white rounded text-[12px] font-bold text-grey-dark transition-colors border border-grey-light touch-manipulation; }

            /* Inputs */
            .input-field { @apply w-full rounded-md border-2 border-grey-light bg-grey-bg px-3 py-2 text-sm font-bold text-grey-dark focus:border-secondary focus:bg-white outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed; }

            /* New DRO Cards (Compacted) - Mobile Responsive */
            .dro-panel { @apply bg-grey-bg rounded-xl p-1.5 md:p-2 shadow-inner mb-2 border border-grey-light; }

            /* The Axis Card Container */
            .dro-card { @apply flex items-stretch bg-white rounded-md shadow-sm border border-grey-light mb-1 overflow-hidden transition-colors h-9 md:h-8; }

            /* The Axis Letter Box - Compacted */
            .dro-label-box { @apply w-12 md:w-12 flex items-center justify-start gap-1 pl-2 font-heading font-black text-lg md:text-lg text-black; }

            /* The Number Area - Compacted */
            .dro-readout { @apply flex-1 flex items-baseline justify-between gap-1 md:gap-2 px-1 md:px-2 py-1 bg-white overflow-hidden; }

            /* Work Position (Big) */
            .dro-val-lg { @apply font-mono text-[20px] md:text-[24px] font-black tracking-tight text-grey-dark leading-none text-right flex-1 tabular-nums mb-0 self-center; }

            /* Machine Position (Small) */
            .dro-val-sm { @apply font-mono text-[11px] md:text-[16px] font-bold text-grey opacity-80 tracking-wider leading-none text-right w-16 md:w-28 flex-shrink-0 tabular-nums self-center; }

            /* The Zero Button inside the card */
            .dro-zero-btn { @apply w-10 md:w-10 border-l border-grey-light bg-grey-bg hover:bg-primary hover:text-black hover:border-primary text-[9px] md:text-[9px] font-bold text-grey uppercase transition-colors flex items-center justify-center active:bg-primary; }

            /* Sub-Controls (G28/G30) */
            .dro-sub-btn {
                @apply flex-1 bg-white border border-grey-light hover:border-secondary rounded text-xs font-bold text-grey-dark py-2 md:py-1 shadow-sm transition-all active:scale-95 flex items-center justify-center gap-1 touch-manipulation;
            }
            /* Jog Styles - Touch Friendly */
            .jog-wrapper { @apply flex gap-3 justify-center; }
            .jog-pad { @apply grid grid-cols-3 gap-1.5; }
            .jog-btn { @apply w-12 h-12 md:w-12 md:h-12 bg-white border-2 border-grey-light rounded-xl text-xl text-grey-dark hover:border-primary hover:text-primary hover:bg-primary-light active:bg-primary active:text-black transition-all shadow-sm flex items-center justify-center touch-manipulation; }
            .jog-extra-col { @apply flex flex-col gap-1.5; }
            .jog-btn-extra { @apply w-12 md:w-12 h-[44px] md:h-[42px] bg-white border-2 border-grey-light rounded-xl text-sm font-bold text-grey-dark hover:border-secondary hover:text-secondary hover:bg-secondary-light active:bg-secondary active:text-white transition-all shadow-sm flex items-center justify-center touch-manipulation; }

            /* Console */
            .console-wrapper { @apply bg-white rounded-lg overflow-hidden p-1 md:p-2 shadow-inner border border-grey-light relative h-32 md:h-40; }

            /* Tabs */
            .tab-btn { @apply py-3 md:py-3 px-3 md:px-4 text-xs md:text-sm font-bold text-grey-light transition-all flex items-center hover:text-white whitespace-nowrap min-w-fit touch-manipulation; }
            .tab-btn.active { @apply bg-grey-bg text-secondary-dark; }

            /* Viewer Overlay */
            .viewer-controls { @apply absolute top-2 md:top-4 right-2 md:right-4 flex flex-col gap-2 z-20; }
            .viewer-controls-left { @apply absolute top-2 md:top-4 left-2 md:left-4 flex flex-col gap-2 z-20; }
            .overlay-btn { @apply bg-white/90 backdrop-blur shadow-md px-3 py-2 rounded-lg text-xs font-bold text-grey-dark hover:text-primary hover:bg-white transition-all flex items-center gap-2 touch-manipulation; }

            /* Hide Scrollbar */
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        }

        .xterm-viewport { overflow-y: auto !important; }
        
        /* Improve xterm selection visibility */
        .xterm .xterm-selection div {
            background-color: rgba(255, 255, 0, 0.5) !important; /* Bright yellow highlight */
        }
    </style>


    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/" } }
    </script>
</head>

<body>

    <div class="app-container">

        <!-- Machine Sidebar (Unified) -->
        <aside class="machine-sidebar" id="machine-sidebar">
            <!-- Mobile Header -->
            <div
                class="md:hidden h-10 flex items-center px-2 bg-secondary-dark text-white justify-between shadow-md z-20 shrink-0">
                <span class="font-bold">Machine Controls</span>
                <button class="text-white" onclick="toggleMachineSidebar()"><i class="bi bi-x-lg"></i></button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-2 flex flex-col gap-2">

                <!-- Handshake & Connection -->
                <div class="bg-secondary-dark p-2 rounded-xl border border-grey-dark shadow-md flex gap-2">
                    <button id="btn-reset"
                        class="btn flex-1 h-9 text-xs shadow-none border border-white/10 opacity-50 pointer-events-none transition-opacity px-2 py-0 bg-white/10 text-white hover:bg-white/20"
                        onclick="sendRealtime('\x18')" title="Soft Reset"><i
                            class="bi bi-exclamation-octagon-fill"></i>Reset
                    </button>
                    <button id="btn-connect"
                        class="btn btn-primary flex-1 h-9 text-xs shadow-none border border-white/10 px-2 py-0">Connect</button>
                </div>

                <!-- DRO Panel -->
                <div class="dro-panel">
                    <!-- Header: WCS & Units -->
                    <div class="flex justify-between items-center mb-1.5 px-1">

                        <!-- Units Toggle -->
                        <label
                            class="inline-flex items-center cursor-pointer bg-white border border-grey-light rounded px-2 py-1 shadow-sm gap-2">
                            <!-- UPDATED: text-[10px] -> text-xs -->
                            <span class="text-xs font-black text-grey uppercase" id="unitLabel">MM</span>
                            <input type="checkbox" id="unitToggle" class="sr-only peer" checked
                                onchange="window.dro.toggleUnits()">
                            <div
                                class="relative w-6 h-3 bg-grey-light rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:border-grey-light after:border after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-secondary">
                            </div>
                        </label>

                        <!-- WCS Select -->
                        <div
                            class="flex items-center gap-2 bg-white border border-grey-light rounded px-2 py-1 shadow-sm">
                            <!-- UPDATED: text-[10px] -> text-xs -->
                            <span class="text-xs font-black text-grey uppercase">WCS</span>
                            <select
                                class="text-xs font-bold text-secondary-dark bg-transparent outline-none cursor-pointer py-0.5"
                                onchange="window.dro.setWCS(this.value)" aria-label="Work Coordinate System">
                                <option value="G54" selected>G54</option>
                                <option value="G55">G55</option>
                                <option value="G56">G56</option>
                                <option value="G57">G57</option>
                                <option value="G58">G58</option>
                                <option value="G59">G59</option>
                            </select>
                        </div>


                    </div>

                    <!-- Accessories Status (Moved to Footer) -->

                    <!-- X Axis -->
                    <div class="dro-card border-l-4 border-l-axis-x">
                        <div class="dro-label-box">
                            <span>X</span>
                            <button id="homing-btn-x"
                                class="text-[10px] text-grey-light hover:text-primary transition-colors"
                                onclick="window.dro.homeAxis('X')" title="Home X">
                                <i class="bi bi-house-door-fill"></i>
                            </button>
                        </div>
                        <div class="dro-readout">
                            <span id="dro-x-m" class="dro-val-sm">0.000</span>
                            <span id="dro-x" class="dro-val-lg">0.000</span>
                        </div>
                        <button class="dro-zero-btn" onclick="window.dro.setZero('X')"
                            aria-label="Zero X axis">Zero</button>
                    </div>

                    <!-- Y Axis -->
                    <div class="dro-card border-l-4 border-l-axis-y">
                        <div class="dro-label-box">
                            <span>Y</span>
                            <button id="homing-btn-y"
                                class="text-[10px] text-grey-light hover:text-primary transition-colors"
                                onclick="window.dro.homeAxis('Y')" title="Home Y">
                                <i class="bi bi-house-door-fill"></i>
                            </button>
                        </div>
                        <div class="dro-readout">
                            <span id="dro-y-m" class="dro-val-sm">0.000</span>
                            <span id="dro-y" class="dro-val-lg">0.000</span>
                        </div>
                        <button class="dro-zero-btn" onclick="window.dro.setZero('Y')"
                            aria-label="Zero Y axis">Zero</button>
                    </div>

                    <!-- Z Axis -->
                    <div class="dro-card border-l-4 border-l-axis-z">
                        <div class="dro-label-box">
                            <span>Z</span>
                            <button id="homing-btn-z"
                                class="text-[10px] text-grey-light hover:text-primary transition-colors"
                                onclick="window.dro.homeAxis('Z')" title="Home Z">
                                <i class="bi bi-house-door-fill"></i>
                            </button>
                        </div>
                        <div class="dro-readout">
                            <span id="dro-z-m" class="dro-val-sm">0.000</span>
                            <span id="dro-z" class="dro-val-lg">0.000</span>
                        </div>
                        <button class="dro-zero-btn" onclick="window.dro.setZero('Z')"
                            aria-label="Zero Z axis">Zero</button>
                    </div>

                    <!-- A Axis (Hidden by default) -->
                    <div class="dro-row hidden dro-card border-l-4 border-l-axis-a">
                        <div class="dro-label-box">
                            <span>A</span>
                            <button id="homing-btn-a"
                                class="text-[10px] text-grey-light hover:text-primary transition-colors"
                                onclick="window.dro.homeAxis('A')" title="Home A">
                                <i class="bi bi-house-door-fill"></i>
                            </button>
                        </div>
                        <div class="dro-readout">
                            <span id="dro-a-m" class="dro-val-sm">0.000</span>
                            <span id="dro-a" class="dro-val-lg">0.000</span>
                        </div>
                        <button class="dro-zero-btn" onclick="window.dro.setZero('A')"
                            aria-label="Zero A axis">Zero</button>
                    </div>



                    <!-- Footer Actions -->
                    <div class="grid grid-cols-3 gap-2 mt-2 pt-2 border-t border-grey-light">
                        <div class="col-span-1 flex flex-col gap-1 items-center justify-center">
                            <span id="machine-state"
                                class="machine-status-pill w-full text-center text-xs font-bold bg-grey-light rounded py-1">Unknown</span>
                            <!-- Icons Moved Here -->
                            <div class="flex justify-center gap-3">
                                <i id="acc-spindle" class="bi bi-fan text-grey-light text-xs transition-colors"
                                    title="Spindle"></i>
                                <i id="acc-flood" class="bi bi-droplet-fill text-grey-light text-xs transition-colors"
                                    title="Flood Coolant"></i>
                                <i id="acc-mist" class="bi bi-cloud-haze-fill text-grey-light text-xs transition-colors"
                                    title="Mist Coolant"></i>
                            </div>
                        </div>
                        <div class="col-span-2 flex gap-1">
                            <button class="dro-sub-btn !bg-primary !text-black !border-primary hover:!bg-primary-dark"
                                onclick="window.dro.home()">
                                <i class="bi bi-house-door-fill"></i> HOME
                            </button>
                            <button class="dro-sub-btn" onclick="window.dro.setZero('XYZ')">SET ZERO ALL</button>
                            <button class="dro-sub-btn" onclick="window.dro.goXY0()">GO XY 0</button>
                        </div>
                    </div>
                </div>

                <!-- Jog Controls (Compact) -->
                <div class="bg-white p-3 rounded-xl border border-grey-light shadow-card">

                    <div class="jog-wrapper">
                        <!-- XY Pad -->
                        <div class="jog-pad">
                            <!-- Row 1 -->
                            <button class="jog-btn rounded-tl-xl" data-jog="X-Y+" aria-label="Jog X minus Y plus"><i
                                    class="bi bi-arrow-up-left"></i></button>

                            <!-- Y+ (Green, Top Border) -->
                            <button class="jog-btn !text-axis-y border-t-4 !border-t-axis-y hover:bg-green-50"
                                data-jog="Y+" aria-label="Jog Y plus"><i
                                    class="bi bi-caret-up-fill text-2xl"></i></button>

                            <button class="jog-btn rounded-tr-xl" data-jog="X+Y+" aria-label="Jog X plus Y plus"><i
                                    class="bi bi-arrow-up-right"></i></button>

                            <!-- Row 2 -->
                            <!-- X- (Red, Left Border) -->
                            <button class="jog-btn !text-axis-x border-l-4 !border-l-axis-x hover:bg-red-50"
                                data-jog="X-" aria-label="Jog X minus"><i
                                    class="bi bi-caret-left-fill text-2xl"></i></button>

                            <div class="w-12 h-12 flex items-center justify-center">
                                <i class="bi bi-dpad-fill text-2xl text-grey-light"></i>
                            </div>

                            <!-- X+ (Red, Right Border) -->
                            <button class="jog-btn !text-axis-x border-r-4 !border-r-axis-x hover:bg-red-50"
                                data-jog="X+" aria-label="Jog X plus"><i
                                    class="bi bi-caret-right-fill text-2xl"></i></button>

                            <!-- Row 3 -->
                            <button class="jog-btn rounded-bl-xl" data-jog="X-Y-" aria-label="Jog X minus Y minus"><i
                                    class="bi bi-arrow-down-left"></i></button>

                            <!-- Y- (Green, Bottom Border) -->
                            <button class="jog-btn !text-axis-y border-b-4 !border-b-axis-y hover:bg-green-50"
                                data-jog="Y-" aria-label="Jog Y minus"><i
                                    class="bi bi-caret-down-fill text-2xl"></i></button>

                            <button class="jog-btn rounded-br-xl" data-jog="X+Y-" aria-label="Jog X plus Y minus"><i
                                    class="bi bi-arrow-down-right"></i></button>
                        </div>

                        <!-- Right Column: Unlock + Z & A, CONTINUOUS -->
                        <div class="flex flex-col gap-2 w-28">
                            <!-- Unlock Button -->
                            <button class="btn btn-secondary w-full h-9 md:h-8 text-xs justify-center shadow-none"
                                onclick="sendCmd('$X')" title="Unlock ($X)"><i class="bi bi-unlock-fill"></i>
                                Unlock</button>

                            <!-- Z & A Buttons -->
                            <div class="flex gap-1.5 justify-center">
                                <!-- Z Pad (Blue) -->
                                <div class="jog-extra-col">
                                    <button
                                        class="jog-btn-extra rounded-t-xl !text-axis-z border-t-4 !border-t-axis-z hover:bg-blue-50"
                                        data-jog="Z+" aria-label="Jog Z plus">Z+</button>
                                    <button
                                        class="jog-btn-extra rounded-b-xl !text-axis-z border-b-4 !border-b-axis-z hover:bg-blue-50"
                                        data-jog="Z-" aria-label="Jog Z minus">Z-</button>
                                </div>
                                <!-- A Pad (Orange) -->
                                <div class="jog-extra-col">
                                    <button
                                        class="jog-btn-extra rounded-t-xl !text-axis-a border-t-4 !border-t-axis-a hover:bg-orange-50"
                                        data-jog="A+" aria-label="Jog A plus">A+</button>
                                    <button
                                        class="jog-btn-extra rounded-b-xl !text-axis-a border-b-4 !border-b-axis-a hover:bg-orange-50"
                                        data-jog="A-" aria-label="Jog A minus">A-</button>
                                </div>
                            </div>

                            <!-- Continuous Toggle -->
                            <label class="inline-flex justify-center cursor-pointer gap-2 mt-1 items-center">
                                <span class="text-[12px] font-bold text-grey uppercase">Incr</span>
                                <input type="checkbox" id="jogContinuous" class="sr-only peer">
                                <div
                                    class="relative w-8 h-4 bg-grey-light border border-grey-light peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:start-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-secondary">
                                </div>
                                <span class="text-[12px] font-bold text-grey uppercase">Cont</span>
                            </label>
                        </div>
                    </div>

                    <!-- Step/Feed -->
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div class="relative">
                            <span class="absolute left-2 top-2 text-[11px] font-bold text-grey uppercase">Dist</span>
                            <select id="stepSize" class="input-field pl-10 text-right h-8 py-0"
                                aria-label="Jog distance step size">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="relative">
                            <span class="absolute left-2 top-2 text-[11px] font-bold text-grey uppercase">Feed</span>
                            <input type="number" id="feedRate" class="input-field pl-10 text-right h-8 py-0">
                        </div>
                    </div>
                </div>
                <!-- Overrides & Signals (Merged from Left) -->
                <div class="grid grid-cols-2 gap-2">
                    <!-- Overrides -->
                    <div class="flex flex-col gap-1.5 bg-white p-2 rounded-xl border border-grey-light shadow-card">
                        <div class="flex items-center justify-between">
                            <span class="text-[9px] font-bold text-grey uppercase">Overrides</span>
                        </div>
                        <!-- Spindle -->
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="font-bold text-grey-dark">Spindle</span>
                            <div class="flex gap-1 items-center">
                                <button onclick="sendRealtime('\x9B')"
                                    class="w-6 h-6 flex items-center justify-center rounded hover:bg-grey-bg transition-colors font-bold">-</button>
                                <span id="spindle-ovr" class="min-w-[35px] text-center font-bold">100%</span>
                                <button onclick="sendRealtime('\x9A')"
                                    class="w-6 h-6 flex items-center justify-center rounded hover:bg-grey-bg transition-colors font-bold">+</button>
                                <button onclick="sendRealtime('\x99')"
                                    class="px-1.5 h-6 flex items-center justify-center rounded bg-primary-light hover:bg-primary transition-colors font-bold text-[8px]"
                                    title="Reset to 100%">RST</button>
                            </div>
                        </div>
                        <!-- Feed -->
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="font-bold text-grey-dark">Feed</span>
                            <div class="flex gap-1 items-center">
                                <button onclick="sendRealtime('\x92')"
                                    class="w-6 h-6 flex items-center justify-center rounded hover:bg-grey-bg transition-colors font-bold">-</button>
                                <span id="feed-ovr" class="min-w-[35px] text-center font-bold">100%</span>
                                <button onclick="sendRealtime('\x91')"
                                    class="w-6 h-6 flex items-center justify-center rounded hover:bg-grey-bg transition-colors font-bold">+</button>
                                <button onclick="sendRealtime('\x90')"
                                    class="px-1.5 h-6 flex items-center justify-center rounded bg-primary-light hover:bg-primary transition-colors font-bold text-[8px]"
                                    title="Reset to 100%">RST</button>
                            </div>
                        </div>
                        <!-- Rapids -->
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="font-bold text-grey-dark">Rapids</span>
                            <div class="flex gap-1 items-center">
                                <span id="rapid-ovr" class="min-w-[35px] text-center font-bold">100%</span>
                                <button onclick="sendRealtime('\x97')"
                                    class="px-1.5 h-6 flex items-center justify-center rounded bg-grey-bg hover:bg-grey-light transition-colors font-bold text-[8px]"
                                    title="Set to 25%">25</button>
                                <button onclick="sendRealtime('\x96')"
                                    class="px-1.5 h-6 flex items-center justify-center rounded bg-grey-bg hover:bg-grey-light transition-colors font-bold text-[8px]"
                                    title="Set to 50%">50</button>
                                <button onclick="sendRealtime('\x95')"
                                    class="px-1.5 h-6 flex items-center justify-center rounded bg-grey-bg hover:bg-grey-light transition-colors font-bold text-[8px]"
                                    title="Set to 100%">100</button>
                            </div>
                        </div>
                    </div>

                    <!-- Signals -->
                    <div class="bg-white p-2 rounded-xl border border-grey-light shadow-card">
                        <span class="text-[9px] font-bold text-grey uppercase block mb-1">Input Signals</span>
                        <div class="grid grid-cols-5 gap-0.5 max-h-24 overflow-y-auto">
                            <!-- Limit Switches -->
                            <div id="pin-indicator-X" title="X Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                X</div>
                            <div id="pin-indicator-Y" title="Y Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                Y</div>
                            <div id="pin-indicator-Z" title="Z Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                Z</div>
                            <div id="pin-indicator-A" title="A Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                A</div>
                            <div id="pin-indicator-B" title="B Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                B</div>
                            <div id="pin-indicator-C" title="C Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                C</div>
                            <div id="pin-indicator-U" title="U Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                U</div>
                            <div id="pin-indicator-V" title="V Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                V</div>
                            <div id="pin-indicator-W" title="W Limit"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                W</div>
                            <!-- Probe -->
                            <div id="pin-indicator-P" title="Probe Triggered"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                P</div>
                            <div id="pin-indicator-O" title="Probe Disconnected"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                O</div>
                            <!-- Control Switches -->
                            <div id="pin-indicator-D" title="Door"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                D</div>
                            <div id="pin-indicator-R" title="Reset"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                R</div>
                            <div id="pin-indicator-H" title="Feed Hold"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                H</div>
                            <div id="pin-indicator-S" title="Cycle Start"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                S</div>
                            <div id="pin-indicator-E" title="E-Stop"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                E</div>
                            <div id="pin-indicator-L" title="Block Delete"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                L</div>
                            <div id="pin-indicator-T" title="Optional Stop"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                T</div>
                            <div id="pin-indicator-Q" title="Single Step"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                Q</div>
                            <!-- Motor Status -->
                            <div id="pin-indicator-M" title="Motor Warning"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                M</div>
                            <div id="pin-indicator-F" title="Motor Fault"
                                class="text-[7px] font-bold text-center border border-grey-light rounded transition-colors py-0.5">
                                F</div>
                        </div>
                    </div>
                </div>



            </div> <!-- End Machine Controls (id="machine-controls") -->

            <!-- Console (Light Mode) -->
            <div class="flex flex-col mb-10 md:mb-0">
                <div class="console-wrapper">
                    <div id="terminal-container" class="w-full h-full"></div>
                </div>
                <!-- Console Input -->
                <div id="console-input-area"
                    class="flex gap-1 mt-1 opacity-50 pointer-events-none transition-opacity duration-200">
                    <input type="text" id="cmdInput" class="input-field font-mono h-8 text-xs flex-1"
                        placeholder="G-Code...">
                    <button id="btnSend" class="btn btn-secondary px-2 h-8"><i
                            class="bi bi-send-fill text-[10px]"></i></button>
                </div>
            </div>
        </aside>

        <!-- Sidebar Overlay (Unified) -->
        <div id="machine-sidebar-overlay" class="sidebar-overlay hidden" onclick="toggleMachineSidebar()"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-grey-bg relative overflow-hidden h-full">

            <!-- Navigation (Updated with Logo and Unified Sidebar Trigger) -->
            <div class="h-10 flex items-center bg-secondary-dark text-white justify-between shadow-md z-20 shrink-0">

                <!-- Sidebar Trigger & Logo & Status -->
                <div class="flex items-center h-full overflow-hidden shrink-0">
                    <!-- Unified Machine Sidebar Toggle -->
                    <button
                        class="h-full px-4 text-primary hover:text-white border-r border-grey-dark flex items-center justify-center transition-colors bg-secondary-dark"
                        onclick="toggleMachineSidebar()" aria-label="Toggle machine controls">
                        <i class="bi bi-list text-xl"></i>
                    </button>

                    <div class="flex items-center gap-2 pl-2 border-r border-white/10 h-full pr-2">
                        <img src="logo.png" alt="Logo" id="app-logo" class="h-6 md:h-7">
                        <!-- Hidden elements kept for JS compatibility -->
                        <div id="connection-dot" class="hidden"></div>
                        <span id="connection-text" class="hidden"></span>
                    </div>
                </div>

                <!-- Left Scroll Arrow -->
                <button
                    class="h-full px-2 text-grey-light hover:text-white flex items-center justify-center transition-colors"
                    onclick="scrollTabs('left')" aria-label="Scroll tabs left">
                    <i class="bi bi-chevron-left text-xs"></i>
                </button>

                <!-- Scrollable Tabs Container -->
                <div id="tabs-scroll-container" class="flex-1 flex overflow-x-auto no-scrollbar scroll-smooth">
                    <button class="tab-btn active" onclick="switchTab('viewer-view', this)">3D Preview</button>
                    <button class="tab-btn" onclick="switchTab('editor-view', this)">Editor</button>
                    <button class="tab-btn" onclick="switchTab('probe-view', this)">Probe</button>
                    <button class="tab-btn" onclick="switchTab('macros-view', this)">Macros</button>
                    <button class="tab-btn" onclick="switchTab('surfacing-view', this)">Surfacing</button>
                    <button class="tab-btn" onclick="switchTab('tools-view', this)">
                        Tools
                        <span id="tools-badge"
                            class="hidden ml-2 tab-badge text-[10px] font-bold px-1.5 py-0 rounded-full text-white">0</span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('sd-view', this)">
                        SD Card
                        <span id="sd-badge"
                            class="hidden ml-2 tab-badge text-[10px] font-bold px-1.5 py-0 rounded-full text-white">0</span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('settings-view', this)">Settings</button>
                </div>

                <!-- Right Scroll Arrow -->
                <button
                    class="h-full px-2 text-grey-light hover:text-white flex items-center justify-center transition-colors border-r border-grey-dark"
                    onclick="scrollTabs('right')" aria-label="Scroll tabs right">
                    <i class="bi bi-chevron-right text-xs"></i>
                </button>

                <!-- Theme Selector -->
                <div class="h-full flex items-center px-4 bg-transparent shrink-0">
                    <select id="theme-selector"
                        class="bg-secondary text-white text-xs px-2 py-1 rounded border border-white/10 outline-none cursor-pointer"
                        onchange="window.changeTheme(this.value)">
                        <option value="solar-yellow">Solar Yellow</option>
                        <option value="ooznest">Ooznest</option>
                    </select>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 relative overflow-hidden"> <!-- Added overflow-hidden here for strict constraint -->

                <!-- 3D Viewer (Default) -->
                <div id="viewer-view" class="tab-pane w-full h-full relative bg-grey-bg overflow-hidden"
                    style="overflow: hidden !important;">
                    <div id="viewer-container" class="absolute inset-0 overflow-hidden"
                        style="overflow: hidden !important;"></div>

                    <!-- Loading Overlay -->
                    <div id="loading-overlay"
                        class="hidden absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                        <div class="bg-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                            <div class="w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin">
                            </div>
                            <span class="font-bold text-grey-dark">Parsing G-Code...</span>
                        </div>
                    </div>

                    <!-- Job Progress Bar Overlay -->
                    <div id="job-progress-overlay"
                        class="hidden absolute bottom-0 left-0 right-0 bg-black/80 backdrop-blur-sm p-4 z-30">
                        <div class="max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-white font-bold text-sm">Job Progress</span>
                                <span id="job-progress-pct" class="text-white font-mono font-bold text-sm">0%</span>
                            </div>
                            <div class="h-3 w-full bg-grey-dark rounded-full overflow-hidden shadow-inner">
                                <div id="job-progress-bar"
                                    class="h-full bg-primary transition-all duration-300 w-0 shadow-lg"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-xs text-grey-light">
                                <span id="job-progress-line">Line 0 of 0</span>
                                <span id="job-progress-time">Elapsed: 0:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Top-Left Controls: Open File -->
                    <div class="viewer-controls-left">
                        <label
                            class="overlay-btn cursor-pointer !bg-primary !text-secondary-dark hover:!bg-primary-dark shadow-lg">
                            <i class="bi bi-folder2-open text-lg"></i> Open File
                            <input type="file" id="gcode-file-input" hidden accept=".gcode,.nc,.gc,.ngc">
                        </label>
                    </div>

                    <!-- Top-Right Controls -->
                    <div class="viewer-controls">
                        <!-- Run Job (Disabled when offline) -->
                        <button id="run-job-btn"
                            class="overlay-btn !bg-primary !text-secondary-dark hover:!bg-primary-dark shadow-lg opacity-50 pointer-events-none transition-opacity duration-200"
                            onclick="runCurrentJob()">
                            <i class="bi bi-play-fill text-lg"></i> Run Job
                        </button>

                        <!-- Run from SD -->
                        <button id="run-sd-btn"
                            class="overlay-btn !bg-secondary !text-white hover:!bg-secondary-dark shadow-lg opacity-50 pointer-events-none transition-opacity duration-200"
                            title="Upload to SD and Run" onclick="runFromSD()">
                            <i class="bi bi-sd-card-fill text-lg"></i> Run from SD
                        </button>

                        <!-- Job Running Controls (Pause/Stop) -->
                        <div id="job-active-controls" class="hidden flex-col gap-2">
                            <button id="pause-job-btn"
                                class="overlay-btn !bg-yellow-100 !text-yellow-800 border-yellow-300 shadow-lg"
                                onclick="pauseJob()">
                                <i class="bi bi-pause-fill text-lg"></i> Pause
                            </button>
                            <button id="stop-job-btn"
                                class="overlay-btn !bg-red-100 !text-red-800 border-red-300 shadow-lg"
                                onclick="stopJob()">
                                <i class="bi bi-stop-fill text-lg"></i> Stop
                            </button>
                        </div>


                        <button class="overlay-btn" onclick="resetCamera()">
                            <i class="bi bi-camera-video-fill text-secondary"></i> Reset
                        </button>

                        <!-- Camera Mode Toggle -->
                        <button class="overlay-btn" onclick="toggleCamera()" id="cam-toggle-btn">
                            <i class="bi bi-eye-fill text-secondary"></i> Perspective
                        </button>

                        <!-- New Grid Mode Toggle -->
                        <button class="overlay-btn" onclick="toggleGridMode()" id="grid-toggle-btn">
                            <i class="bi bi-grid-3x3 text-secondary"></i> Grid: Job
                        </button>

                        <!-- Laser Mode Toggle -->
                        <button class="overlay-btn" onclick="toggleLaserMode()" id="laser-toggle-btn">
                            <i class="bi bi-brightness-high-fill text-secondary"></i> Laser Mode
                        </button>
                    </div>
                </div>

                <!-- G-Code Editor View -->
                <div id="editor-view" class="tab-pane hidden w-full h-full flex flex-col bg-grey-bg relative">

                    <!-- Toolbar -->
                    <div
                        class="h-12 bg-white border-b border-grey-light flex items-center justify-between px-4 shrink-0 shadow-sm z-10">
                        <div class="flex items-center gap-2">
                            <h3 class="text-sm font-bold text-secondary-dark uppercase tracking-wider">
                                <i class="bi bi-code-square"></i> G-Code Editor
                            </h3>
                            <span id="editor-file-name" class="text-xs text-grey italic ml-2">No file loaded</span>
                        </div>

                        <div class="flex gap-2">
                            <button class="btn btn-secondary text-xs h-8" onclick="applyEditorChanges()">
                                <i class="bi bi-play-circle-fill text-primary-dark"></i> Update Preview
                            </button>
                            <button class="btn btn-secondary text-xs h-8" onclick="downloadFromEditor()">
                                <i class="bi bi-download"></i> Save to PC
                            </button>
                            <button class="btn btn-primary text-xs h-8" onclick="uploadEditorToSD()">
                                <i class="bi bi-sd-card-fill"></i> Upload to SD
                            </button>
                        </div>
                    </div>

                    <!-- The Virtual Editor Container -->
                    <div class="flex-1 relative bg-white">
                        <div id="gcode-editor" class="absolute inset-0"></div>
                    </div>

                    <!-- Status Footer -->
                    <div
                        class="h-6 bg-grey-bg border-t border-grey-light flex items-center px-2 text-[10px] text-grey font-mono justify-between shrink-0">
                        <span>Lines: <span id="editor-line-count">0</span></span>
                        <span>Virtualized Render Active</span>
                    </div>
                </div>

                <!-- Macros View -->
                <div id="macros-view" class="tab-pane hidden w-full h-full p-4 md:p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-6xl mx-auto pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-lightning-charge-fill"></i> Custom Macros
                                </h2>
                                <p class="text-sm text-grey">Quickly execute predefined G-code sequences.</p>
                            </div>
                            <button class="btn btn-secondary shadow-soft w-full md:w-auto"
                                onclick="window.macroHandler.openModal(null)">
                                <i class="bi bi-plus-lg"></i> Create New
                            </button>
                        </div>

                        <!-- Macro Grid -->
                        <div id="macro-grid"
                            class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Surfacing Wizard -->
                <div id="surfacing-view" class="tab-pane hidden w-full h-full p-4 md:p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-5xl mx-auto pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2"><i
                                        class="bi bi-layers-fill"></i> Surfacing Wizard</h2>
                                <p class="text-sm text-grey">Generate G-code to flatten stock or spoilboards.</p>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button class="btn btn-primary shadow-soft w-full"
                                    onclick="window.surfacing.loadToViewer()"><i class="bi bi-check-lg"></i> Generate
                                    G-Code</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Column 1: Specs -->
                            <div class="space-y-6">
                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3
                                        class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        Tool & Speeds</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Tool
                                                Diameter (mm)</label><input type="number" id="surf-tool"
                                                class="input-field font-mono text-sm"></div>
                                        <div><label
                                                class="text-[11px] font-bold text-secondary-dark block mb-1">Stepover
                                                (%)</label><input type="number" id="surf-stepover"
                                                class="input-field font-mono text-sm"></div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Feed
                                                Rate (mm/min)</label><input type="number" id="surf-feed"
                                                class="input-field font-mono text-sm"></div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Spindle
                                                RPM</label><input type="number" id="surf-rpm"
                                                class="input-field font-mono text-sm"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3
                                        class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        Dimensions</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label
                                                    class="text-[11px] font-bold text-secondary-dark block mb-1">Width
                                                    (X)</label><input type="number" id="surf-x"
                                                    class="input-field font-mono text-sm"></div>
                                            <div><label
                                                    class="text-[11px] font-bold text-secondary-dark block mb-1">Height
                                                    (Y)</label><input type="number" id="surf-y"
                                                    class="input-field font-mono text-sm"></div>
                                        </div>
                                        <div>
                                            <label class="text-[11px] font-bold text-secondary-dark block mb-1">Cutting
                                                Direction</label>
                                            <select id="surf-dir" class="input-field text-sm">
                                                <option value="X">Along X-Axis</option>
                                                <option value="Y">Along Y-Axis</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Column 2: Depth & Options -->
                            <div class="space-y-6">
                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3
                                        class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        Depth Control</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label
                                                    class="text-[11px] font-bold text-secondary-dark block mb-1">Depth
                                                    per Pass (mm)</label><input type="number" id="surf-z-step"
                                                    class="input-field font-mono text-sm"></div>
                                            <div><label
                                                    class="text-[11px] font-bold text-secondary-dark block mb-1">Final
                                                    Depth (mm)</label><input type="number" id="surf-z-final"
                                                    class="input-field font-mono text-sm"></div>
                                        </div>
                                        <div><label class="text-[11px] font-bold text-secondary-dark block mb-1">Safe Z
                                                Clearance (mm)</label><input type="number" id="surf-z-safe"
                                                class="input-field font-mono text-sm"></div>
                                    </div>
                                </div>

                                <div class="bg-white p-5 rounded-xl border border-grey-light shadow-soft">
                                    <h3
                                        class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        Options</h3>

                                    <div
                                        class="flex items-center justify-between bg-grey-bg p-3 rounded-lg border border-grey-light mb-2">
                                        <span class="text-xs font-bold text-secondary-dark">Use Coolant (M8)?</span>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="surf-coolant" class="sr-only peer">
                                            <div
                                                class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>

                                    <div
                                        class="flex items-center justify-between bg-grey-bg p-3 rounded-lg border border-grey-light">
                                        <span class="text-xs font-bold text-secondary-dark">Add Framing Pass?</span>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="surf-framing" class="sr-only peer">
                                            <div
                                                class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary">
                                            </div>
                                        </label>
                                    </div>

                                    <div
                                        class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-[11px] text-yellow-800">
                                        <i class="bi bi-info-circle-fill mr-1"></i>
                                        Ensure your spindle is trammed perpendicular to the bed. Start Z-Zero at the
                                        highest point of your stock.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SD Card -->
                <div id="sd-view" class="tab-pane hidden w-full h-full p-4 md:p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sd-card-fill"></i> SD Card
                                </h2>
                                <p class="text-sm text-grey">Manage files stored on your controller.</p>
                            </div>
                            <!-- SD Actions (Disabled when offline) -->
                            <div id="sd-tools"
                                class="flex gap-2 w-full md:w-auto opacity-50 pointer-events-none transition-opacity duration-200">
                                <button class="btn btn-primary shadow-soft flex-1 md:flex-initial"
                                    onclick="document.getElementById('sd-upload-input').click()">
                                    <i class="bi bi-cloud-upload-fill"></i> Upload
                                </button>
                                <button class="btn btn-secondary shadow-soft flex-1 md:flex-initial"
                                    onclick="window.sdHandler.refresh()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <input type="file" id="sd-upload-input" hidden>
                        </div>

                        <!-- Breadcrumb (Disabled when offline) -->
                        <div id="sd-breadcrumb"
                            class="bg-white border border-grey-light rounded-lg p-3 mb-4 flex items-center gap-3 shadow-card opacity-50 pointer-events-none transition-opacity duration-200">
                            <button class="btn-icon text-grey-dark" onclick="window.sdHandler.upLevel()"
                                aria-label="Go up one directory level">
                                <i class="bi bi-arrow-90deg-up"></i>
                            </button>
                            <span class="text-grey-light">|</span>
                            <span id="sd-current-path" class="font-mono font-bold text-grey-dark">/</span>
                        </div>

                        <!-- Upload Progress -->
                        <div id="upload-progress-container"
                            class="hidden mb-6 bg-white p-4 rounded-lg border border-grey-light shadow-soft">
                            <div class="flex justify-between text-xs font-bold text-grey mb-2 uppercase">
                                <span>Transferring...</span>
                                <span id="upload-pct">0%</span>
                            </div>
                            <div class="h-2 w-full bg-grey-bg rounded-full overflow-hidden">
                                <div id="upload-progress-bar" class="h-full bg-primary transition-all duration-300 w-0">
                                </div>
                            </div>
                        </div>

                        <!-- File Table (Restored White) -->
                        <div class="bg-white border border-grey-light rounded-xl shadow-soft overflow-x-auto">
                            <table class="w-full text-left text-sm min-w-[500px]" id="sd-table">
                                <thead
                                    class="bg-grey-bg border-b border-grey-light text-grey uppercase text-[10px] tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4 font-bold">Filename</th>
                                        <th class="px-6 py-4 font-bold">Size</th>
                                        <th class="px-6 py-4 font-bold text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-grey-light">
                                    <tr>
                                        <td colspan="3" class="px-6 py-12 text-center text-grey italic">
                                            Click Refresh to load files...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tool Table -->
                <div id="tools-view" class="tab-pane hidden w-full h-full p-4 md:p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-6xl mx-auto pb-20">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-tools"></i> Tool Table
                                </h2>
                                <p class="text-sm text-grey">Manage tool library and offsets (G10 L1). requires
                                    <code>N_TOOLS > 0</code>.
                                </p>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button class="btn btn-secondary shadow-soft w-full md:w-auto"
                                    onclick="window.toolsHandler.refresh()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh ($#)
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-250px)] min-h-[500px]">

                            <!-- Tool List -->
                            <div
                                class="lg:col-span-4 xl:col-span-3 bg-white rounded-xl border border-grey-light shadow-soft flex flex-col overflow-hidden">
                                <div
                                    class="p-3 border-b border-grey-light bg-grey-bg font-bold text-xs text-grey uppercase tracking-wider flex justify-between">
                                    <span>Library</span>
                                    <span id="tool-count-badge">0</span>
                                </div>
                                <div class="flex-1 overflow-y-auto p-0 relative">
                                    <table class="w-full text-left text-sm">
                                        <thead
                                            class="sticky top-0 bg-white shadow-sm text-[10px] text-grey uppercase font-bold z-10">
                                            <tr>
                                                <th class="px-4 py-2 border-b border-grey-light text-center w-14">Tool
                                                </th>
                                                <th class="px-4 py-2 border-b border-grey-light text-right">Z-Offset
                                                </th>
                                                <th class="px-4 py-2 border-b border-grey-light text-right">Dia</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tool-table-body"
                                            class="divide-y divide-grey-light cursor-pointer select-none bg-white">
                                            <tr>
                                                <td colspan="3" class="p-6 text-center text-grey italic">No tools
                                                    loaded.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tool Editor -->
                            <div
                                class="lg:col-span-8 xl:col-span-9 bg-white p-6 rounded-xl border border-grey-light shadow-soft flex flex-col gap-6 overflow-y-auto">

                                <!-- Toolbar -->
                                <div class="flex justify-between items-center border-b border-grey-light pb-4">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-12 h-12 rounded-lg bg-primary flex items-center justify-center font-black text-xl border border-black/10 shadow-sm">
                                            T<span id="edit-tool-id-display">?</span>
                                        </div>
                                        <div>
                                            <label class="text-[10px] font-bold text-grey uppercase block mb-0.5">Tool
                                                Number</label>
                                            <input type="number" id="edit-tool-num"
                                                class="font-mono text-2xl font-bold w-24 outline-none bg-transparent placeholder-grey/30"
                                                placeholder="#" min="1" max="255">
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <!-- <button class="btn btn-secondary text-xs" onclick="window.toolsHandler.clearFields()">
                                            <i class="bi bi-eraser-fill"></i> Clear
                                        </button>
                                        <button class="btn btn-danger text-xs" onclick="window.toolsHandler.deleteTool()">
                                            <i class="bi bi-trash-fill"></i> Delete
                                        </button> -->
                                    </div>
                                </div>

                                <!-- Fields -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div class="space-y-5">
                                        <h4
                                            class="text-xs font-black text-grey uppercase tracking-wider border-b border-grey-light pb-1">
                                            Geometry (G10 L1)</h4>

                                        <!-- Z Offset -->
                                        <div class="flex items-end gap-2">
                                            <div class="flex-1">
                                                <label class="text-[11px] font-bold text-secondary-dark block mb-1">Z
                                                    Offset</label>
                                                <div class="relative">
                                                    <input type="number" id="edit-tool-z"
                                                        class="input-field pl-8 font-mono text-lg" step="0.001"
                                                        placeholder="0.000">
                                                    <span
                                                        class="absolute left-3 top-2.5 text-grey font-bold text-xs">Z</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-secondary h-[42px] px-3"
                                                onclick="window.toolsHandler.setFromCurrent('Z')"
                                                title="Teach Z from Machine Position">
                                                <i class="bi bi-geo-alt-fill"></i> Teach
                                            </button>
                                        </div>

                                        <!-- Diameter -->
                                        <div class="flex items-end gap-2">
                                            <div class="flex-1">
                                                <label
                                                    class="text-[11px] font-bold text-secondary-dark block mb-1">Diameter</label>
                                                <div class="relative">
                                                    <input type="number" id="edit-tool-dia"
                                                        class="input-field pl-8 font-mono text-lg" step="0.01"
                                                        placeholder="0.00">
                                                    <span
                                                        class="absolute left-3 top-2.5 text-grey font-bold text-xs"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- XY Offsets (Usually 0 for Spindles) -->
                                        <div class="grid grid-cols-2 gap-4 pt-2">
                                            <div>
                                                <label class="text-[10px] font-bold text-grey block mb-1">X
                                                    Offset</label>
                                                <input type="number" id="edit-tool-x"
                                                    class="input-field font-mono text-sm" step="0.001"
                                                    placeholder="0.000">
                                            </div>
                                            <div>
                                                <label class="text-[10px] font-bold text-grey block mb-1">Y
                                                    Offset</label>
                                                <input type="number" id="edit-tool-y"
                                                    class="input-field font-mono text-sm" step="0.001"
                                                    placeholder="0.000">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div
                                        class="flex flex-col justify-between bg-white p-4 rounded-xl border border-grey-light">
                                        <div class="space-y-3">
                                            <p class="text-xs text-grey font-bold uppercase"><i
                                                    class="bi bi-info-circle-fill"></i> Description</p>
                                            <textarea id="edit-tool-desc" class="input-field h-24 resize-none text-xs"
                                                placeholder="Endmill, Ballnose, etc... (Note: Description storage depends on sender DB, not stored in grblHAL)"></textarea>
                                        </div>

                                        <button
                                            class="btn btn-primary h-14 text-base shadow-md w-full mt-6 justify-center"
                                            onclick="window.toolsHandler.saveTool()">
                                            <i class="bi bi-save-fill"></i> Save Tool (G10 L1)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grbl Settings -->
                <div id="settings-view" class="tab-pane hidden w-full h-full p-4 md:p-8 overflow-y-auto bg-grey-bg">
                    <div class="max-w-5xl mx-auto pb-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-sliders"></i> Machine Settings
                                </h2>
                                <p class="text-sm text-grey">Configure GrblHAL firmware parameters.</p>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full md:w-auto" id="settings-toolbar">
                                <button class="btn btn-secondary flex-1" onclick="window.grblSettings.fetchSettings()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-secondary flex-1" onclick="window.grblSettings.backup()">
                                    <i class="bi bi-download"></i> Backup
                                </button>
                                <button class="btn btn-secondary flex-1"
                                    onclick="document.getElementById('settings-restore-input').click()">
                                    <i class="bi bi-upload"></i> Restore
                                </button>
                                <input type="file" id="settings-restore-input" hidden
                                    onchange="window.grblSettings.restore(this.files[0])">

                                <button class="btn btn-primary flex-1" onclick="window.grblSettings.saveChanges()">
                                    <i class="bi bi-save"></i> Save
                                </button>
                            </div>
                        </div>

                        <!-- Settings Table Container -->
                        <div id="grbl-settings-container" class="overflow-x-auto">
                            <!-- populated by js -->
                        </div>
                    </div>
                </div>


                <!-- START OF FILE index.html (Replace the entire probe-view div) -->

                <!-- Probing Tab -->
                <div id="probe-view" class="tab-pane hidden w-full h-full bg-grey-bg overflow-y-auto">
                    <div id="probe-panel-content"
                        class="max-w-6xl mx-auto p-4 md:p-6 opacity-50 pointer-events-none transition-opacity duration-200 pb-20">

                        <!-- Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                            <div>
                                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2">
                                    <i class="bi bi-bullseye"></i> Probing
                                </h2>
                                <p class="text-sm text-grey">Tool offsets, edge finding, and alignment.</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary shadow-soft"
                                    onclick="window.probeHandler.saveSettings()">
                                    <i class="bi bi-save"></i> Save Settings
                                </button>
                            </div>
                        </div>

                        <!-- Main Layout: Sidebar Config + Tabbed Content -->
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

                            <!-- LEFT COLUMN: Global Configuration (Always Visible) -->
                            <div class="lg:col-span-4 xl:col-span-3 order-2 lg:order-1">
                                <div class="bg-white p-4 rounded-xl border border-grey-light shadow-soft sticky top-4">
                                    <h3
                                        class="text-xs font-black text-grey uppercase tracking-wider mb-4 border-b border-grey-light pb-2">
                                        <i class="bi bi-gear-fill"></i> Probe Config
                                    </h3>
                                    <div class="space-y-3">
                                        <!-- Plate Toggle -->
                                        <div
                                            class="bg-grey-bg p-2 rounded border border-grey-light flex justify-between items-center">
                                            <span class="text-xs font-bold text-secondary-dark">Touch Plate?</span>
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="prb-use-plate-main" class="sr-only peer"
                                                    onchange="window.probeHandler.saveSettings()">
                                                <div
                                                    class="relative w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:start-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3.5 after:w-3.5 after:transition-all peer-checked:bg-primary">
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Basic Params -->
                                        <div><label class="text-[10px] font-bold text-grey block mb-1">Probe
                                                Diameter</label>
                                            <input type="number" id="prb-tool" class="input-field font-mono text-xs h-8"
                                                step="0.01">
                                        </div>
                                        <div><label class="text-[10px] font-bold text-grey block mb-1">Plate Thickness
                                                (Z)</label>
                                            <input type="number" id="prb-z-thick"
                                                class="input-field font-mono text-xs h-8" step="0.01">
                                        </div>
                                        <div><label class="text-[10px] font-bold text-grey block mb-1">Plate Offset
                                                (XY)</label>
                                            <input type="number" id="prb-xy-offset"
                                                class="input-field font-mono text-xs h-8" step="0.01">
                                        </div>

                                        <hr class="border-grey-light">

                                        <!-- Speeds -->
                                        <div class="grid grid-cols-2 gap-2">
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Fast
                                                    Feed</label>
                                                <input type="number" id="prb-feed"
                                                    class="input-field font-mono text-xs h-8">
                                            </div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Latch
                                                    Feed</label>
                                                <input type="number" id="prb-feed-latch"
                                                    class="input-field font-mono text-xs h-8">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Max
                                                    Dist</label>
                                                <input type="number" id="prb-dist"
                                                    class="input-field font-mono text-xs h-8">
                                            </div>
                                            <div><label
                                                    class="text-[10px] font-bold text-grey block mb-1">Retract</label>
                                                <input type="number" id="prb-retract"
                                                    class="input-field font-mono text-xs h-8">
                                            </div>
                                        </div>
                                        <div><label class="text-[10px] font-bold text-grey block mb-1">XY
                                                Clearance</label>
                                            <input type="number" id="prb-edge-dist"
                                                class="input-field font-mono text-xs h-8">
                                        </div>
                                        <div><label class="text-[10px] font-bold text-grey block mb-1">Z Depth
                                                (Edges)</label>
                                            <input type="number" id="prb-z-depth"
                                                class="input-field font-mono text-xs h-8">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- RIGHT COLUMN: Tabbed Interface -->
                            <div class="lg:col-span-8 xl:col-span-9 order-1 lg:order-2 flex flex-col">

                                <!-- Internal Tabs -->
                                <div class="flex border-b border-grey-light mb-4 overflow-x-auto no-scrollbar">

                                    <button
                                        class="px-4 py-2 text-sm font-bold text-primary-dark border-b-2 border-primary transition-colors hover:bg-white whitespace-nowrap probe-tab-btn"
                                        data-target="tab-edges"
                                        onclick="window.probeHandler.switchProbeTab('tab-edges', this)">
                                        Edge & Corners
                                    </button>
                                    <button
                                        class="px-4 py-2 text-sm font-bold text-grey border-b-2 border-transparent transition-colors hover:text-secondary-dark hover:bg-white whitespace-nowrap probe-tab-btn"
                                        data-target="tab-centers"
                                        onclick="window.probeHandler.switchProbeTab('tab-centers', this)">
                                        Center Finder
                                    </button>
                                    <button
                                        class="px-4 py-2 text-sm font-bold text-grey border-b-2 border-transparent transition-colors hover:text-secondary-dark hover:bg-white whitespace-nowrap probe-tab-btn"
                                        data-target="tab-rotation"
                                        onclick="window.probeHandler.switchProbeTab('tab-rotation', this)">
                                        Rotation
                                    </button>
                                    <button
                                        class="px-4 py-2 text-sm font-bold text-grey border-b-2 border-transparent transition-colors hover:text-secondary-dark hover:bg-white whitespace-nowrap probe-tab-btn"
                                        data-target="tab-tlo"
                                        onclick="window.probeHandler.switchProbeTab('tab-tlo', this)">
                                        Tool Length Offset
                                    </button>
                                </div>

                                <!-- TAB CONTENT: Tool Length Offset -->
                                <div id="tab-tlo" class="probe-tab-content hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-soft border border-grey-light">
                                        <h3 class="font-bold text-lg text-secondary-dark mb-4">Tool Length Offset (TLO)
                                        </h3>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- Config -->
                                            <div class="space-y-4">
                                                <div
                                                    class="bg-blue-50 p-4 rounded-lg border border-blue-100 text-xs text-blue-800 leading-relaxed">
                                                    <i class="bi bi-info-circle-fill mr-1"></i>
                                                    <strong>Workflow:</strong>
                                                    1. Establish a reference with your first tool. <br>
                                                    2. Change tool. <br>
                                                    3. Measure new tool. The difference is applied to the Z Work
                                                    Coordinate System (G54...).
                                                </div>

                                                <div class="bg-grey-bg p-3 rounded-lg border border-grey-light">
                                                    <h4 class="text-xs font-bold text-grey uppercase mb-2">Fixed Tool
                                                        Setter Location (G53)</h4>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <div><label class="text-[9px] font-bold text-grey">X</label>
                                                            <input type="number" id="tlo-x"
                                                                class="input-field h-8 text-xs" placeholder="0.0">
                                                        </div>
                                                        <div><label class="text-[9px] font-bold text-grey">Y</label>
                                                            <input type="number" id="tlo-y"
                                                                class="input-field h-8 text-xs" placeholder="0.0">
                                                        </div>
                                                        <div><label class="text-[9px] font-bold text-grey">Z
                                                                (Start)</label>
                                                            <input type="number" id="tlo-z"
                                                                class="input-field h-8 text-xs" placeholder="-5.0">
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2 mt-2">
                                                        <button class="btn btn-secondary text-[10px] w-full"
                                                            onclick="window.probeHandler.setTLOFromMachine()">
                                                            <i class="bi bi-geo-alt"></i> Get Current Pos
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>


                                            <!-- Actions -->
                                            <div class="flex flex-col gap-3 justify-center">

                                                <!-- Button 1: Reference (Height set to auto to prevent overflow) -->
                                                <button
                                                    class="btn btn-secondary h-auto py-3 flex-col items-center justify-center gap-1 border-2"
                                                    onclick="window.probeHandler.runTLO('reference')">
                                                    <i class="bi bi-1-circle-fill text-2xl text-primary-dark"></i>
                                                    <span class="text-sm font-bold">1. Establish Reference</span>
                                                    <span class="text-[10px] text-grey font-normal">Probe First
                                                        Tool</span>
                                                </button>

                                                <div class="flex items-center justify-center text-grey-light">
                                                    <i class="bi bi-arrow-down text-xl"></i>
                                                </div>

                                                <!-- Button 2: Measure (Height set to auto) -->
                                                <button
                                                    class="btn btn-primary h-auto py-3 flex-col items-center justify-center gap-1 shadow-md"
                                                    onclick="window.probeHandler.runTLO('measure')">
                                                    <i class="bi bi-rulers text-2xl"></i>
                                                    <span class="text-sm font-bold">2. Measure New Tool</span>
                                                    <span class="text-[10px] text-black/60 font-normal">Adjusts WCS Z
                                                        Zero</span>
                                                </button>

                                                <div class="mt-2 text-center">
                                                    <span
                                                        class="text-xs font-mono bg-grey-bg px-2 py-1 rounded text-grey-dark"
                                                        id="tlo-status">Ref: Not Set</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB CONTENT: Edges & Corners (Existing logic refined) -->
                                <div id="tab-edges" class="probe-tab-content space-y-4 block">

                                    <!-- Corners -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <!-- Outside Corner -->
                                        <div class="bg-white p-4 rounded-xl shadow-soft border border-grey-light">
                                            <div class="flex justify-between items-start mb-2">
                                                <h3 class="font-bold text-secondary-dark text-sm"><i
                                                        class="bi bi-box"></i> Outside Corner</h3>
                                                <span class="text-[9px] text-grey font-bold plate-status-text">Mode:
                                                    Plate</span>
                                            </div>
                                            <div class="flex gap-4">
                                                <div class="w-24 h-24 grid grid-cols-2 gap-1 flex-shrink-0">
                                                    <button
                                                        class="corner-sel-btn rounded-tl bg-grey-bg border border-grey-light hover:bg-primary h-full"
                                                        data-corner="RL"
                                                        onclick="window.probeHandler.selectCorner(this, 'Outside', 'RL')"></button>
                                                    <button
                                                        class="corner-sel-btn rounded-tr bg-grey-bg border border-grey-light hover:bg-primary h-full"
                                                        data-corner="RR"
                                                        onclick="window.probeHandler.selectCorner(this, 'Outside', 'RR')"></button>
                                                    <button
                                                        class="corner-sel-btn rounded-bl bg-primary border-2 border-black/20 ring-2 ring-primary/30 h-full"
                                                        data-corner="FL"
                                                        onclick="window.probeHandler.selectCorner(this, 'Outside', 'FL')"></button>
                                                    <button
                                                        class="corner-sel-btn rounded-br bg-grey-bg border border-grey-light hover:bg-primary h-full"
                                                        data-corner="FR"
                                                        onclick="window.probeHandler.selectCorner(this, 'Outside', 'FR')"></button>
                                                </div>
                                                <button class="btn btn-primary flex-1 h-auto"
                                                    onclick="window.probeHandler.runCornerProbe('Outside')">Start</button>
                                            </div>
                                        </div>

                                        <!-- Inside Corner -->
                                        <div class="bg-white p-4 rounded-xl shadow-soft border border-grey-light">
                                            <div class="flex justify-between items-start mb-2">
                                                <h3 class="font-bold text-secondary-dark text-sm"><i
                                                        class="bi bi-bounding-box"></i> Inside Corner</h3>
                                                <span class="text-[9px] text-grey font-bold plate-status-text">Mode:
                                                    Plate</span>
                                            </div>
                                            <div class="flex gap-4">
                                                <div
                                                    class="w-24 h-24 grid grid-cols-2 gap-1 flex-shrink-0 p-1 bg-grey-light rounded-lg">
                                                    <button class="corner-sel-btn rounded-tl bg-white h-full"
                                                        onclick="window.probeHandler.selectCorner(this, 'Inside', 'RL')"></button>
                                                    <button class="corner-sel-btn rounded-tr bg-white h-full"
                                                        onclick="window.probeHandler.selectCorner(this, 'Inside', 'RR')"></button>
                                                    <button
                                                        class="corner-sel-btn rounded-bl bg-primary border-2 border-black/20 h-full"
                                                        onclick="window.probeHandler.selectCorner(this, 'Inside', 'FL')"></button>
                                                    <button class="corner-sel-btn rounded-br bg-white h-full"
                                                        onclick="window.probeHandler.selectCorner(this, 'Inside', 'FR')"></button>
                                                </div>
                                                <button class="btn btn-secondary flex-1 h-auto"
                                                    onclick="window.probeHandler.runCornerProbe('Inside')">Start</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Single Axis -->
                                    <div class="bg-white p-4 rounded-xl shadow-soft border border-grey-light">
                                        <div class="flex justify-between items-center mb-2">
                                            <h3 class="font-bold text-secondary-dark text-xs uppercase tracking-wider">
                                                Single Surface</h3>
                                            <span class="text-[10px] text-grey font-bold plate-status-text">Mode:
                                                Plate</span>
                                        </div>
                                        <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                            <button class="btn btn-secondary flex-1 py-3 flex-col gap-1 min-w-[70px]"
                                                onclick="window.probeHandler.runSingleAxis('X', 1)">
                                                <i class="bi bi-arrow-bar-right text-xl"></i><span
                                                    class="text-[10px]">X+</span>
                                            </button>
                                            <button class="btn btn-secondary flex-1 py-3 flex-col gap-1 min-w-[70px]"
                                                onclick="window.probeHandler.runSingleAxis('X', -1)">
                                                <i class="bi bi-arrow-bar-left text-xl"></i><span
                                                    class="text-[10px]">X-</span>
                                            </button>
                                            <button class="btn btn-secondary flex-1 py-3 flex-col gap-1 min-w-[70px]"
                                                onclick="window.probeHandler.runSingleAxis('Y', 1)">
                                                <i class="bi bi-arrow-bar-up text-xl"></i><span
                                                    class="text-[10px]">Y+</span>
                                            </button>
                                            <button class="btn btn-secondary flex-1 py-3 flex-col gap-1 min-w-[70px]"
                                                onclick="window.probeHandler.runSingleAxis('Y', -1)">
                                                <i class="bi bi-arrow-bar-down text-xl"></i><span
                                                    class="text-[10px]">Y-</span>
                                            </button>
                                            <button class="btn btn-primary flex-1 py-3 flex-col gap-1 min-w-[70px]"
                                                onclick="window.probeHandler.runZProbe()">
                                                <i class="bi bi-arrow-bar-down text-xl"></i><span class="text-[10px]">Z
                                                    Surface</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB CONTENT: Center Finder -->
                                <div id="tab-centers" class="probe-tab-content hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-soft border border-grey-light mb-4">
                                        <div class="flex items-center gap-2 mb-4">
                                            <h3 class="font-bold text-secondary-dark text-sm">Boss / Stock Dimensions
                                            </h3>
                                            <i class="bi bi-info-circle text-xs text-grey"
                                                title="Approximate size required for Boss probing"></i>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4 max-w-sm">
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Width
                                                    (X)</label>
                                                <input type="number" id="prb-boss-x" class="input-field h-8 text-sm"
                                                    placeholder="0.0">
                                            </div>
                                            <div><label class="text-[10px] font-bold text-grey block mb-1">Height
                                                    (Y)</label>
                                                <input type="number" id="prb-boss-y" class="input-field h-8 text-sm"
                                                    placeholder="0.0">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="bg-white p-4 rounded-xl border border-grey-light text-center">
                                            <i class="bi bi-circle-square text-3xl text-secondary mb-2 block"></i>
                                            <h4 class="font-bold text-sm">Inside Pocket</h4>
                                            <button class="btn btn-secondary w-full mt-3"
                                                onclick="window.probeHandler.runPocketCenter()">Probe</button>
                                        </div>
                                        <div class="bg-white p-4 rounded-xl border border-grey-light text-center">
                                            <i class="bi bi-square-fill text-3xl text-secondary mb-2 block"></i>
                                            <h4 class="font-bold text-sm">Rect Boss</h4>
                                            <button class="btn btn-secondary w-full mt-3"
                                                onclick="window.probeHandler.runBossCenter('Rect')">Probe</button>
                                        </div>
                                        <div class="bg-white p-4 rounded-xl border border-grey-light text-center">
                                            <i class="bi bi-circle-fill text-3xl text-secondary mb-2 block"></i>
                                            <h4 class="font-bold text-sm">Circular Boss</h4>
                                            <button class="btn btn-secondary w-full mt-3"
                                                onclick="window.probeHandler.runBossCenter('Circ')">Probe</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- TAB CONTENT: Rotation (New) -->
                                <div id="tab-rotation" class="probe-tab-content hidden">
                                    <div class="bg-white p-6 rounded-xl shadow-soft border border-grey-light">
                                        <h3 class="font-bold text-lg text-secondary-dark mb-4">Workpiece Rotation</h3>

                                        <div class="flex flex-col md:flex-row gap-6">
                                            <div class="flex-1 space-y-4">
                                                <p class="text-xs text-grey leading-relaxed">
                                                    Probes two points along an edge to determine the angle of the
                                                    material.
                                                    Use this to physically align your stock.
                                                </p>

                                                <div class="bg-grey-bg p-3 rounded-lg border border-grey-light">
                                                    <label class="text-[10px] font-bold text-grey block mb-1">Probe
                                                        Distance (P1 to P2)</label>
                                                    <input type="number" id="rot-dist" class="input-field h-8 text-sm"
                                                        value="50">
                                                    <p class="text-[9px] text-grey mt-1">Distance to move along X before
                                                        probing P2.</p>
                                                </div>

                                                <div class="flex gap-2">
                                                    <button class="btn btn-primary flex-1"
                                                        onclick="window.probeHandler.runRotationProbe()">
                                                        <i class="bi bi-arrow-clockwise"></i> Measure Angle
                                                    </button>
                                                </div>
                                            </div>

                                            <div
                                                class="flex-1 flex flex-col items-center justify-center bg-blue-50 rounded-xl border border-blue-100 p-4">
                                                <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Measured
                                                    Angle</h4>
                                                <span class="text-4xl font-mono font-black text-secondary-dark"
                                                    id="rot-result">0.00</span>
                                                <p class="text-[10px] text-blue-600 mt-2 text-center" id="rot-msg">Ready
                                                    to probe.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <!-- Macro Modal -->
    <div id="macro-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-[600px] overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-grey-light flex justify-between items-center bg-grey-bg">
                <h3 class="text-lg font-bold text-secondary-dark flex items-center gap-2"><i
                        class="bi bi-lightning-charge-fill"></i> <span id="macro-modal-title">Create New Macro</span>
                </h3>
                <button id="btn-close-macro" class="btn-ghost"><i class="bi bi-x-lg"></i></button>
            </div>

            <div class="p-6 overflow-y-auto space-y-4">

                <!-- Name & Color -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2 space-y-1">
                        <label class="text-[11px] font-bold text-grey uppercase">Macro Name</label>
                        <input type="text" id="macro-name-input" class="input-field" placeholder="e.g. Probe Z">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[11px] font-bold text-grey uppercase">Color</label>
                        <select id="macro-color-select" class="input-field">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <!-- Icon Selection -->
                <div class="space-y-1">
                    <label class="text-[11px] font-bold text-grey uppercase">Icon</label>
                    <input type="hidden" id="macro-icon-input">
                    <div id="macro-icon-grid"
                        class="flex flex-wrap gap-2 p-2 border border-grey-light rounded-lg bg-grey-bg">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- G-Code Area -->
                <div class="space-y-1 flex-1">
                    <label class="text-[11px] font-bold text-grey uppercase">G-Code Sequence</label>
                    <textarea id="macro-gcode-input"
                        class="w-full h-40 font-mono text-sm border-2 border-grey-light rounded-lg p-3 bg-grey-bg focus:bg-white focus:border-secondary outline-none resize-none"
                        placeholder="G21&#10;G91&#10;G0 Z10"></textarea>
                    <p class="text-[10px] text-grey italic">Enter one G-code command per line.</p>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-grey-light bg-grey-bg flex justify-end gap-2">
                <button class="btn btn-secondary"
                    onclick="document.getElementById('macro-modal').classList.add('hidden')">Cancel</button>
                <button class="btn btn-primary" id="btn-save-macro">Save Macro</button>
            </div>
        </div>
    </div>

    <!-- Tool Change Modal -->
    <div id="tool-change-modal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border-4 border-primary animate-in fade-in zoom-in duration-200">
            <!-- Header -->
            <div class="bg-primary p-4 flex justify-between items-center">
                <h3 class="text-xl font-black text-black uppercase flex items-center gap-2">
                    <i class="bi bi-exclamation-triangle-fill"></i> Manual Tool Change
                </h3>
                <div class="bg-black/20 text-black px-2 py-0.5 rounded text-xs font-bold">M6</div>
            </div>

            <!-- Body -->
            <div class="p-6 space-y-6">
                <div class="text-center space-y-2">
                    <p class="text-lg font-bold text-secondary-dark">The machine has requested a tool change.</p>
                    <p class="text-sm text-grey">Spindle is stopped. Jogging is enabled.</p>
                </div>

                <!-- Steps -->
                <div class="bg-grey-bg p-4 rounded-xl border border-grey-light text-sm space-y-2 text-grey-dark">
                    <div class="flex gap-3">
                        <div
                            class="font-bold bg-white w-6 h-6 rounded-full flex items-center justify-center border border-grey-light shrink-0">
                            1</div>
                        <span>Change the physical tool.</span>
                    </div>
                    <div class="flex gap-3">
                        <div
                            class="font-bold bg-white w-6 h-6 rounded-full flex items-center justify-center border border-grey-light shrink-0">
                            2</div>
                        <span>Jog to safe location (if needed).</span>
                    </div>
                    <div class="flex gap-3">
                        <div
                            class="font-bold bg-white w-6 h-6 rounded-full flex items-center justify-center border border-grey-light shrink-0">
                            3</div>
                        <span>Probe or set length offsets.</span>
                    </div>
                </div>

                <!-- Helper Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="btn btn-secondary text-xs h-10" onclick="ws.sendCommand('$TLR')">
                        Set Length Ref ($TLR)
                    </button>
                    <button class="btn btn-secondary text-xs h-10" onclick="ws.sendCommand('$TPW')">
                        Probe Workpiece ($TPW)
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 bg-grey-bg border-t border-grey-light flex justify-between gap-3">
                <div class="text-[10px] text-grey leading-tight flex-1">
                    Click Resume only after tool is set.<br>Machine will return to previous pos.
                </div>
                <button class="btn btn-primary px-8 shadow-lg" onclick="window.toolsHandler.resumeToolChange()">
                    <i class="bi bi-play-fill text-xl"></i> RESUME
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        function switchTab(targetId, btn) {
            // 1. Hide all panes
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));

            // 2. Show target pane
            const target = document.getElementById(targetId);
            if (target) target.classList.remove('hidden');

            // 3. Update buttons
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // 4. Global Event: Notify listeners that a tab was shown
            // (Moved OUTSIDE the specific checks so Editor gets it too)
            window.dispatchEvent(new CustomEvent('tab-shown', { detail: { id: targetId } }));

            // 5. Specific Handlers
            if (targetId === 'viewer-view') {
                window.dispatchEvent(new Event('resize'));
            }
            if (targetId === 'macros-view') {
                if (window.macroHandler) window.macroHandler.render();
            }

            // Close machine sidebar on mobile when tab is clicked
            if (window.innerWidth < 1024) { // Match lg breakpoint
                const sidebar = document.getElementById('machine-sidebar');
                const overlay = document.getElementById('machine-sidebar-overlay');
                if (sidebar) sidebar.classList.remove('open');
                if (overlay) overlay.classList.add('hidden');
            }
        }

        function toggleMachineSidebar() {
            const sidebar = document.getElementById('machine-sidebar');
            const overlay = document.getElementById('machine-sidebar-overlay');
            if (sidebar) sidebar.classList.toggle('open');
            if (overlay) overlay.classList.toggle('hidden');
        }

        // New function to scroll the tabs
        function scrollTabs(direction) {
            const container = document.getElementById('tabs-scroll-container');
            const scrollAmount = 150;
            if (direction === 'left') {
                container.scrollLeft -= scrollAmount;
            } else {
                container.scrollLeft += scrollAmount;
            }
        }

        // Apply and save Theme
        window.changeTheme = function (themeName) {
            const link = document.getElementById('theme-stylesheet');
            if (link) {
                link.href = `themes/${themeName}.css`;
            }
            // Update Logo
            const logo = document.getElementById('app-logo');
            if (logo) {
                logo.src = `themes/${themeName}-logo.png`;
                // Add fallback in case theme doesn't have a logo
                logo.onerror = function () { this.src = 'logo.png'; this.onerror = null; };
            }
            if (window.store) {
                window.store.set('uiTheme', themeName);
            }
        }
    </script>

    <script type="module">
        import { WebSerial } from './webserial.js';
        import { GCodeViewer } from './3dview.js';
        import { ProbeHandler } from './probe.js';
        import { SDCardHandler } from './sdcard.js';
        import { AlarmsAndErrors } from './alarms_and_errors.js';
        import { DROHandler } from './dro.js';
        import { GrblSettings } from './grbl_settings.js';
        import { AppStore } from './store.js';
        import { SurfacingHandler } from './surfacing.js';
        import { MacroHandler } from './macros.js';
        import { ToolsHandler } from './tools.js';
        import { GCodeEditor } from './editor.js';
        import { initializeApp } from './init.js';

        // Import new modules
        import './ui.js';
        import './job-control.js';
        import './jogging.js';
        import './console.js';
        import './editor-integration.js';
        import './camera-controls.js';
        import './line-processor.js';

        // Globals
        const ws = new WebSerial();
        const store = new AppStore();
        window.ws = ws;
        window.store = store;

        window.addEventListener('beforeunload', (e) => {
            if (ws && ws.isConnected) {
                e.preventDefault();
                e.returnValue = "Closing this tab will disconnect the CNC controller. Are you sure?";
                return e.returnValue;
            }
        });

        const viewer = new GCodeViewer('viewer-container', 'loading-overlay', store); // Added store
        const reporter = new AlarmsAndErrors(ws);
        window.viewer = viewer;
        window.reporter = reporter; // Make reporter globally accessible

        // --- ERROR HANDLING ---
        ws.on('error', (err) => {
            let msg = err.message;
            let code = "Connection";
            if (msg.includes("Failed to open serial port")) {
                msg = "Unable to open serial port. It may be in use by another application or tab.";
                code = "Port Busy";
            }
            reporter.showModal('ERROR', code, msg);
        });

        let term, fitAddon, statusInterval;

        let currentGCodeContent = null;
        let currentSDFile = null; // Track SD file context
        let gcodeStreamer = { active: false, lines: [], index: 0, paused: false };
        let commandHistory = [];
        let historyIndex = -1;
        let sdHandler = null;
        let droHandler = null;
        let grblSettings = null;
        let probeHandler = null;
        let surfacingHandler = null;
        // DOMContentLoaded - Initialize all modules
        document.addEventListener('DOMContentLoaded', () => {
            // Apply Saved Theme
            const savedTheme = window.store ? window.store.get('uiTheme') : null;
            if (savedTheme) {
                window.changeTheme(savedTheme);
                const themeSelector = document.getElementById('theme-selector');
                if (themeSelector) themeSelector.value = savedTheme;
            }

            // Sync Grid Toggle Button Text on Init
            const gridBtn = document.getElementById('grid-toggle-btn');
            if (gridBtn && viewer.gridMode === 'machine') {
                gridBtn.innerHTML = `<i class="bi bi-grid-3x3 text-secondary"></i> Grid: Machine`;
            }

            // Initialize Editor
            const editor = new GCodeEditor('gcode-editor');
            window.editor = editor;

            // Initialize core modules first (which sets up window.term)
            initializeApp(ws, store, viewer, reporter, null);

            // Initialize Helpers
            const droHandler = new DROHandler(ws, window.term, store);
            window.droHandler = droHandler;
            window.dro = droHandler;

            const grblSettings = new GrblSettings(ws, window.term);
            window.grblSettings = grblSettings;
            grblSettings.init('grbl-settings-container');

            const sdHandler = new SDCardHandler(ws, window.term, viewer, {
                onDownloadComplete: (content, filename, fullPath) => {
                    window.currentGCodeContent = content;
                    window.currentSDFile = fullPath;
                    window.uiManager.updateRunButtonsState();
                    if (editor) {
                        editor.setValue(content);
                        const lineCount = editor.getValue().split('\n').length;
                        document.getElementById('editor-line-count').innerText = lineCount;
                        document.getElementById('editor-file-name').innerText = filename;
                    }
                },
                switchToViewer: () => window.switchTab('viewer-view'),
                pausePolling: () => {
                    if (window.uiManager.statusInterval) clearInterval(window.uiManager.statusInterval);
                },
                resumePolling: () => {
                    window.uiManager.statusInterval = setInterval(() => ws.sendRealtime('?'), 50);
                }
            });
            window.sdHandler = sdHandler;

            const probeHandler = new ProbeHandler(ws, window.term, store);
            window.probeHandler = probeHandler;

            const surfacingHandler = new SurfacingHandler(viewer, sdHandler, window.term, store);
            window.surfacing = surfacingHandler;

            const macroHandler = new MacroHandler(ws, window.term);
            window.macroHandler = macroHandler;

            const toolsHandler = new ToolsHandler(ws, window.term, store);
            window.toolsHandler = toolsHandler;
        });

        window.addEventListener('gcode-loaded', (e) => {
            window.currentGCodeContent = e.detail;
            window.currentSDFile = null; // Clear SD context for generated code
            window.uiManager.updateRunButtonsState();
            // Update editor when Surfacing wizard generates code
            if (window.editor) {
                window.editor.setValue(e.detail);
                const lineCount = window.editor.getValue().split('\n').length;
                document.getElementById('editor-line-count').innerText = lineCount;
                document.getElementById('editor-file-name').innerText = "Surfacing_Job.gcode";
            }
        });

        window.addEventListener('tab-shown', (e) => {
            if (e.detail.id === 'tools-view') window.toolsHandler.refresh();
        });

        // Unit Syncing
        const unitToggle = document.getElementById('unitToggle');
        unitToggle.addEventListener('change', () => {
            const units = unitToggle.checked ? 'mm' : 'inch';
            if (window.viewer) window.viewer.setUnits(units);
        });

        window.addEventListener('viewer-units-changed', (e) => {
            const isMm = e.detail.units === 'mm';
            if (unitToggle.checked !== isMm) {
                unitToggle.checked = isMm;
                const label = document.getElementById('unitLabel');
                if (label) label.innerText = isMm ? 'MM' : 'IN';
            }
        });

        ws.on('connect', () => window.uiManager.updateConnectionState(true, ws, window.sdHandler));
        ws.on('disconnect', () => window.uiManager.updateConnectionState(false, ws, window.sdHandler));
        ws.on('line', (line) => {
            window.lineProcessor.processLine(line);
            window.toolsHandler.handleLine(line);
        });
        ws.on('sent', (line) => {
            if (window.sdHandler?.isDownloading) return;
            if (window.jobController.gcodeStreamer.active) return;
            if (line === '?' || line === '$G') return;
            window.term.writeln(`\x1b[2m> ${line}\x1b[0m`);
        });

        const connectBtn = document.getElementById('btn-connect');
        connectBtn.addEventListener('click', () => {
            if (ws.isConnected) {
                ws.disconnect();
            } else {
                ws.connect(115200).catch(e => { });
            }
        });

        // Note: btnSend click and cmdInput keydown are registered in console.js via setupInputListeners()
        // Note: gcode-file-input and sd-upload-input are registered in editor-integration.js via setupFileInputListeners()
        // Note: resize and tab-shown window listeners are registered in init.js
        // All called from initializeApp() - duplicate listeners here would cause double-send / double-processing

        // New Grid Toggle Function
        window.toggleGridMode = function () {
            const label = viewer.toggleGridMode();
            document.getElementById('grid-toggle-btn').innerHTML = `<i class="bi bi-grid-3x3 text-secondary"></i> ${label}`;
        };

        window.resetCamera = function () { viewer.resetCamera(); };
        window.sendCmd = function (cmd) { ws.sendCommand(cmd); };
        window.sendRealtime = function (c) { ws.sendRealtime(c); };
        window.requestFullStatus = function () {
            window.userRequestedStatus = true;
            ws.sendRealtime('\x87');
        };
        window.clearTerminal = function () { window.term.clear(); }

        // Editor Actions
        window.applyEditorChanges = function () {
            if (!window.editor) return;
            const content = window.editor.getValue();
            window.currentGCodeContent = content;

            viewer.processGCodeString(content);
            switchTab('viewer-view');
            window.term.writeln("\x1b[32m[Editor] Job updated from editor.\x1b[0m");
        };

        window.downloadFromEditor = function () {
            if (!window.editor) return;
            const content = window.editor.getValue();
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = document.getElementById('editor-file-name').innerText || 'edited_job.gcode';
            a.click();
            URL.revokeObjectURL(url);
        };

        window.uploadEditorToSD = function () {
            if (!window.editor) return;
            const content = window.editor.getValue();
            const defaultName = document.getElementById('editor-file-name').innerText !== "No file loaded" ? document.getElementById('editor-file-name').innerText : "edited.gcode";
            reporter.showPrompt('Upload to SD Card', 'Enter filename for SD Card:', defaultName, (filename) => {

                if (!filename) return;

                const file = new File([content], filename, { type: "text/plain" });
                switchTab('sd-view');
                window.sdHandler.startUpload(file);
            });
        };

        // New function: Run from SD (Smart)
        window.runFromSD = function () {
            // Case 1: File is already on SD (Context Aware)
            if (window.currentSDFile) {
                reporter.showConfirm('Run from SD', `Run ${window.currentSDFile} directly from SD card?`, () => {
                    // Start SD Print
                    ws.sendCommand(`$F=${window.currentSDFile}`);
                    // UI will update via status reports
                });
                return;
            }

            // Case 2: Upload Editor Content then Run
            if (!window.editor) return;
            const content = window.editor.getValue();
            const defaultName = document.getElementById('editor-file-name').innerText !== "No file loaded" ? document.getElementById('editor-file-name').innerText : "job.gcode";

            reporter.showPrompt('Upload & Run', 'Upload this job to SD card and run it?', defaultName, (filename) => {
                if (!filename) return;
                const file = new File([content], filename, { type: "text/plain" });

                // Switch to SD view to show progress
                switchTab('sd-view');

                // Start Upload with Callback
                window.sdHandler.startUpload(file, (uploadedName) => {
                    // On Success, Ask to Run
                    const fullPath = window.sdHandler.path === '/' ? uploadedName : `${window.sdHandler.path}/${uploadedName}`;
                    setTimeout(() => {
                        reporter.showConfirm('Run Now?', `Upload complete. Run ${uploadedName} now?`, () => {
                            ws.sendCommand(`$F=${fullPath}`);
                        });
                    }, 500);
                });
            });
        };

        // --- Shared Job UI Helpers ---

        // --- SD Job Progress Listeners ---
        window.sdJobActive = false;

        window.addEventListener('sd-status', (e) => {
            const { pct, filename } = e.detail;

            // If SD job just started (or we just noticed it)
            if (!window.sdJobActive && !window.jobControl.gcodeStreamer.active) {
                window.sdJobActive = true;
                window.jobControl.startJobUI();
                window.term.writeln("\x1b[35m[SD Job] Detected active SD print.\x1b[0m");
            }

            if (window.sdJobActive) {
                window.jobControl.updateJobProgressUI(pct, filename ? `File: ${filename}` : 'Standard Job');
            }
        });

        window.addEventListener('sd-job-complete', () => {
            if (window.sdJobActive) {
                window.term.writeln("\x1b[32m[SD Job] Complete/Idle.\x1b[0m");
                window.jobControl.resetJobUI();
                // Also ensure we are not in Hold
                const pauseBtn = document.getElementById('pause-job-btn');
                if (pauseBtn.innerText.includes('Resume')) {
                    // Reset pause button visual state if it was paused
                    pauseBtn.innerHTML = '<i class="bi bi-pause-fill text-lg"></i> Pause';
                    pauseBtn.className = "overlay-btn !bg-yellow-100 !text-yellow-800 border-yellow-300 shadow-lg";
                }
            }
        });

        // SD Mount State Listener
        window.addEventListener('sd-mount-state', (e) => {
            const state = e.detail.state;
            // 0=Unmounted, 1=Mounted, 2=Unmounted(Auto), 3=Mounted(Auto)
            const isMounted = (state === 1 || state === 3);

            const sdLink = document.querySelector("button[onclick*='switchTab'][onclick*='sd-view']");

            if (isMounted) {
                // Enabled
                if (sdLink) {
                    sdLink.classList.remove('opacity-50', 'pointer-events-none');
                    // update tooltip or visual?
                }
            } else {
                // Disabled
                if (sdLink && !window.sdJobActive) { // Don't disable if printing
                    sdLink.classList.add('opacity-50', 'pointer-events-none');
                }
            }
        });

        // --- Laser Mode & Progress ---
        window.toggleLaserMode = function () {
            if (!window.viewer) return;
            const btn = document.getElementById('laser-toggle-btn');
            // Toggle
            const newState = !window.viewer.isLaserMode;
            window.viewer.setLaserMode(newState);

            if (newState) {
                btn.innerHTML = '<i class="bi bi-brightness-high-fill text-primary-dark"></i> Laser: ON';
                btn.classList.add('!bg-primary-light', 'border-primary');
                btn.classList.remove('text-grey-dark');
                btn.classList.add('text-primary-dark');
            } else {
                btn.innerHTML = '<i class="bi bi-brightness-high-fill text-secondary"></i> Laser Mode';
                btn.classList.remove('!bg-primary-light', 'border-primary', 'text-primary-dark');
                btn.classList.add('text-grey-dark');
            }
        }

        window.addEventListener('gcode-line', (e) => {
            if (window.viewer) {
                window.viewer.updateProgress(e.detail.line);
            }
        });

        // Context Menu Handler: Set Work Zero at Machine X,Y
        window.setWorkZeroAt = function (mX, mY) {
            let activeP = 1; // Default to G54 (P1)
            // Try to determine active WCS from DRO handler status string if possible, 
            // but simpler is to assume G54 OR assume the user knows.
            // Actually, we can get it from the last status report or droHandler if exposed.

            // Best Effort: If we have window.dro (the DroHandler instance)
            // Check if it has activeWCS (it sends 'G54', 'G55' etc in update?)
            // Let's check window.droHandler (it's initialized in init())

            if (window.droHandler && window.droHandler.wcs) {
                // wcs might be 'G54', 'G55'...
                const wcsMap = { 'G54': 1, 'G55': 2, 'G56': 3, 'G57': 4, 'G58': 5, 'G59': 6 };
                if (wcsMap[window.droHandler.activeWCS]) activeP = wcsMap[window.droHandler.activeWCS];
                // Note: droHandler probably doesn't expose 'activeWCS' publicly as a property... 
                // It only seems to log it or use it internally. 
                // Let's check dro.js again? Steps revealed it parses status string but maybe not exposed.
                // We can parse the laststatus string: window.lastStatus
            }

            // Simpler fallback: just use G10 L2 P0 (which in some firmwares is active coordinate system)
            // Spec says L2 P0 is not valid usually (1-9).
            // Let's try to parse from window.lastStatus if available.
            if (window.lastStatus) {
                const match = window.lastStatus.match(/WCS:G(\d+)/);
                if (match) {
                    const val = parseInt(match[1]);
                    if (val >= 54 && val <= 59) activeP = val - 53;
                }
            }

            // Command: G10 L2 P<active> X<mX> Y<mY>
            window.sendCmd(`G10 L2 P${activeP} X${mX} Y${mY}`);
            window.reporter.showToast(`Set Work Zero (G${53 + activeP}) to X${mX} Y${mY}`);
        };

    </script>
</body>

</html>